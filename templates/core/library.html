{% extends 'base.html' %}
{% load static %}

{% block title %}Minha Biblioteca - CGBookStore{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/library-profile.css' %}">
    <link rel="stylesheet" href="{% static 'css/reading-progress.css' %}">
{% endblock %}

{% block content %}
<div class="theme-{{ selected_theme }}" style="width: 100%;">
    <div class="container-fluid px-md-4">
        {# Garante que a pagina nao quebre se o perfil ainda nao existir. #}
        {% if profile %}
            {% include 'core/widgets/profile_hero.html' %}
        {% endif %}

        <div class="library-container theme-{{ selected_theme }}"
             {% if profile and profile.custom_background %}
             style="background-image: url('{{ profile.custom_background.url }}');
                    background-size: {{ profile.background_style }};
                    background-position: center;
                    background-repeat: {% if profile.background_style == 'repeat' %}repeat{% else %}no-repeat{% endif %};
                    position: relative;"
             data-custom-background="{{ profile.custom_background.url }}"
             data-background-style="{{ profile.background_style }}"
             data-background-opacity="{{ profile.background_opacity }}"
             {% endif %}>

            <!-- Overlay para opacidade -->
            {% if profile and profile.custom_background %}
            <div class="library-bg-overlay"
                 style="position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, calc({{ profile.background_opacity }} / 100));
                        pointer-events: none;
                        z-index: 0;"></div>
            {% endif %}
            <!-- Barra Lateral -->
            <aside class="library-sidebar">
                <h5 class="recuo">Minha Biblioteca</h5>

                <!-- Navega√ß√£o Principal -->
                <div class="library-nav-item active" data-shelf="favorites" onclick="showShelf('favorites')">
                    <i class="fas fa-heart text-danger"></i>
                    <span>Favoritos</span>
                    <span class="count" id="favorites-count">{{ favorites_count }}</span>
                </div>

                <div class="library-nav-item" data-shelf="to_read" onclick="showShelf('to_read')">
                    <i class="fas fa-bookmark text-primary"></i>
                    <span>Quero Ler</span>
                    <span class="count" id="to-read-count">{{ to_read_count }}</span>
                </div>

                <div class="library-nav-item" data-shelf="reading" onclick="showShelf('reading')">
                    <i class="fas fa-book-open text-success"></i>
                    <span>Lendo</span>
                    <span class="count" id="reading-count">{{ reading_count }}</span>
                </div>

                <div class="library-nav-item" data-shelf="read" onclick="showShelf('read')">
                    <i class="fas fa-check-circle text-info"></i>
                    <span>Lidos</span>
                    <span class="count" id="read-count">{{ read_count }}</span>
                </div>

                <div class="library-nav-item" data-shelf="abandoned" onclick="showShelf('abandoned')">
                    <i class="fas fa-trash-alt text-warning"></i>
                    <span>Abandonados</span>
                    <span class="count" id="abandoned-count">{{ abandoned_count }}</span>
                </div>

                <hr class="my-3">

                <!-- Estatasticas -->
                {# ? ATUALIZADO: Vari√°veis padronizadas para usar o objeto 'profile' #}
                {% if profile %}
                    <div class="stats-card">
                        <div class="value">{{ profile.total_xp }}</div>
                        <div class="label">Pontos</div>
                    </div>

                    <div class="stats-card">
                        <div class="value">{{ profile.books_read_this_year }}</div>
                        <div class="label">Livros este ano</div>
                    </div>

                    <div class="stats-card">
                        <div class="value">{{ profile.level }}</div>
                        <div class="label">{{ profile.level_name }}</div>
                    </div>
                {% endif %}

                <hr class="my-3">

                <!-- Prateleiras Personalizadas -->
                <h5 class="recuo-personalizado">Personalizadas</h5>

                <button class="btn btn-sm btn-outline-primary w-100 mb-3" onclick="showLibraryCustomShelfModal()">
                    <i class="fas fa-plus me-2"></i>Nova Prateleira
                </button>
                <button class="btn btn-sm btn-outline-success w-100 mb-3" data-bs-toggle="modal" data-bs-target="#manageShelvesModal">
                    <i class="fas fa-cog me-2"></i>Minhas Prateleiras
                </button>

                {% if custom_shelves %}
                {% for shelf in custom_shelves %}
                <div class="library-nav-item"
                     data-shelf="custom-{{ shelf.name }}"
                     data-shelf-type="custom"
                     data-custom-name="{{ shelf.name }}"
                     onclick="showShelf('custom', '{{ shelf.name }}')">
                    <i class="fas fa-folder"></i>
                    <span>{{ shelf.name }}</span>
                    <span class="count">{{ shelf.count }}</span>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted small px-2">Nenhuma prateleira personalizada ainda.</p>
                {% endif %}
            </aside>

            <!-- Conteudo Principal -->
            <main class="library-content">
                <!-- Header -->
                <div class="library-header">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                            <h2 id="shelf-title">Favoritos</h2>
                            <p class="subtitle" id="shelf-subtitle">
                                <span id="shelf-count">{{ favorites_count }}</span> livro(s)
                            </p>
                        </div>
                        <div>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBookModal">
                                <i class="fas fa-plus-circle"></i> Adicionar Livro
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Grid de Livros - Favoritos -->
                <div class="books-grid" id="shelf-favorites" style="display: grid;">
                    {% if favorites %}
                        {% for item in favorites %}
                        <div class="book-card"
                             data-bookshelf-id="{{ item.id }}"
                             data-notes="{{ item.notes|default:'' }}">
                            <a href="{% url 'core:book_detail' item.book.slug %}">
                                <div class="book-cover-container">
                                    {% if item.book.cover_image %}
                                    <img src="{{ item.book.cover_image.url }}"
                                         alt="{{ item.book.title }}"
                                         class="book-cover">
                                    {% else %}
                                    <img src="https://via.placeholder.com/160x240/6c757d/ffffff?text=Sem+Capa"
                                         alt="{{ item.book.title }}"
                                         class="book-cover">
                                    {% endif %}
                                </div>
                            </a>
                            <div class="book-title">{{ item.book.title|truncatewords:4 }}</div>
                            <div class="book-author">{{ item.book.author.name }}</div>
                            <div class="book-actions">
                                <button class="btn btn-sm btn-outline-danger btn-remove-from-library"
                                        data-bookshelf-id="{{ item.id }}"
                                        title="Remover">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-shelf" style="grid-column: 1 / -1;">
                            <i class="fas fa-heart"></i>
                            <h4>Nenhum favorito ainda</h4>
                            <p>Adicione livros aos seus favoritos para ve-los aqui!</p>
                            <a href="{% url 'core:book_list' %}" class="btn btn-primary mt-3">
                                Explorar Livros
                            </a>
                        </div>
                    {% endif %}
                </div>

                <!-- Grid de Livros - Quero Ler -->
                <div class="books-grid" id="shelf-to_read" style="display: none;">
                    {% if to_read %}
                        {% for item in to_read %}
                        <div class="book-card"
                             data-bookshelf-id="{{ item.id }}"
                             data-notes="{{ item.notes|default:'' }}">
                            <a href="{% url 'core:book_detail' item.book.slug %}">
                                <div class="book-cover-container">
                                    {% if item.book.cover_image %}
                                    <img src="{{ item.book.cover_image.url }}"
                                         alt="{{ item.book.title }}"
                                         class="book-cover">
                                    {% else %}
                                    <img src="https://via.placeholder.com/160x240/6c757d/ffffff?text=Sem+Capa"
                                         alt="{{ item.book.title }}"
                                         class="book-cover">
                                    {% endif %}
                                </div>
                            </a>
                            <div class="book-title">{{ item.book.title|truncatewords:4 }}</div>
                            <div class="book-author">{{ item.book.author.name }}</div>
                            <div class="book-actions">
                                <button class="btn btn-sm btn-outline-danger btn-remove-from-library"
                                        data-bookshelf-id="{{ item.id }}"
                                        title="Remover">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-shelf" style="grid-column: 1 / -1;">
                            <i class="fas fa-bookmark"></i>
                            <h4>Nenhum livro para ler</h4>
                            <p>Adicione livros √† sua lista "Quero Ler"!</p>
                            <a href="{% url 'core:book_list' %}" class="btn btn-primary mt-3">
                                Explorar Livros
                            </a>
                        </div>
                    {% endif %}
                </div>

                <!-- Grid de Livros - Lendo -->
                <div class="books-grid" id="shelf-reading" style="display: none;">
                    {% if reading %}
                        {% for item in reading %}
                        <div class="book-card"
                             data-bookshelf-id="{{ item.id }}"
                             data-notes="{{ item.notes|default:'' }}">
                            <a href="{% url 'core:book_detail' item.book.slug %}">
                                <div class="book-cover-container">
                                    {% if item.book.cover_image %}
                                    <img src="{{ item.book.cover_image.url }}"
                                         alt="{{ item.book.title }}"
                                         class="book-cover">
                                    {% else %}
                                    <img src="https://via.placeholder.com/160x240/6c757d/ffffff?text=Sem+Capa"
                                         alt="{{ item.book.title }}"
                                         class="book-cover">
                                    {% endif %}
                                </div>
                            </a>
                            <div class="book-title">{{ item.book.title|truncatewords:4 }}</div>
                            <div class="book-author">{{ item.book.author.name }}</div>

                            <!-- Barra de Progresso -->
                            {% if item.book.reading_progress.first %}
                            {% with progress=item.book.reading_progress.first %}
                            <div class="mt-2">
                                <!-- Barra de progresso visual simples -->
                                <div class="progress" style="height: 6px; border-radius: 3px;">
                                    <div class="progress-bar bg-success"
                                         role="progressbar"
                                         style="width: {{ progress.percentage }}%"
                                         aria-valuenow="{{ progress.percentage }}"
                                         aria-valuemin="0"
                                         aria-valuemax="100">
                                    </div>
                                </div>

                                <!-- Info b√°sica -->
                                <div class="d-flex justify-content-between align-items-center mt-1">
                                    <small class="text-muted">
                                        {{ progress.current_page }}/{{ progress.total_pages }} p√°ginas
                                    </small>
                                    <span class="badge bg-success">{{ progress.percentage }}%</span>
                                </div>
                            </div>
                            {% endwith %}
                            {% endif %}

                            <div class="book-actions">
                                <button class="btn btn-sm btn-outline-danger btn-remove-from-library"
                                        data-bookshelf-id="{{ item.id }}"
                                        title="Remover">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-shelf" style="grid-column: 1 / -1;">
                            <i class="fas fa-book-open"></i>
                            <h4>Nenhum livro sendo lido</h4>
                            <p>Comece a ler um livro agora!</p>
                            <a href="{% url 'core:book_list' %}" class="btn btn-primary mt-3">
                                Explorar Livros
                            </a>
                        </div>
                    {% endif %}
                </div>

                <!-- Grid de Livros - Lidos -->
                <div class="books-grid" id="shelf-read" style="display: none;">
                    {% if read %}
                        {% for item in read %}
                        <div class="book-card"
                             data-bookshelf-id="{{ item.id }}"
                             data-notes="{{ item.notes|default:'' }}">
                            <a href="{% url 'core:book_detail' item.book.slug %}">
                                <div class="book-cover-container">
                                    {% if item.book.cover_image %}
                                    <img src="{{ item.book.cover_image.url }}"
                                         alt="{{ item.book.title }}"
                                         class="book-cover">
                                    {% else %}
                                    <img src="https://via.placeholder.com/160x240/6c757d/ffffff?text=Sem+Capa"
                                         alt="{{ item.book.title }}"
                                         class="book-cover">
                                    {% endif %}
                                </div>
                            </a>
                            <div class="book-title">{{ item.book.title|truncatewords:4 }}</div>
                            <div class="book-author">{{ item.book.author.name }}</div>
                            <div class="book-actions">
                                <button class="btn btn-sm btn-outline-danger btn-remove-from-library"
                                        data-bookshelf-id="{{ item.id }}"
                                        title="Remover">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-shelf" style="grid-column: 1 / -1;">
                            <i class="fas fa-check-circle"></i>
                            <h4>Nenhum livro lido</h4>
                            <p>Complete sua primeira leitura!</p>
                            <a href="{% url 'core:book_list' %}" class="btn btn-primary mt-3">
                                Explorar Livros
                            </a>
                        </div>
                    {% endif %}
                </div>

                <!-- Grid de Livros - Abandonados -->
                <div class="books-grid" id="shelf-abandoned" style="display: none;">
                    {% if abandoned %}
                        {% for item in abandoned %}
                        <div class="book-card"
                             data-bookshelf-id="{{ item.id }}"
                             data-notes="{{ item.notes|default:'' }}">
                            <a href="{% url 'core:book_detail' item.book.slug %}">
                                <div class="book-cover-container">
                                    {% if item.book.cover_image %}
                                    <img src="{{ item.book.cover_image.url }}"
                                         alt="{{ item.book.title }}"
                                         class="book-cover">
                                    {% else %}
                                    <img src="https://via.placeholder.com/160x240/6c757d/ffffff?text=Sem+Capa"
                                         alt="{{ item.book.title }}"
                                         class="book-cover">
                                    {% endif %}
                                </div>
                            </a>
                            <div class="book-title">{{ item.book.title|truncatewords:4 }}</div>
                            <div class="book-author">{{ item.book.author.name }}</div>

                            {% if item.book.reading_progress.first %}
                            <small class="text-muted d-block mt-1 mb-2">
                                Progresso: {{ item.book.reading_progress.first.percentage }}%
                            </small>
                            {% endif %}

                            <div class="book-actions">
                                <button
                                    class="btn btn-sm btn-success btn-restore-book"
                                    data-book-id="{{ item.book.id }}"
                                >
                                    <i class="fas fa-undo"></i> Restaurar
                                </button>
                                <button class="btn btn-sm btn-outline-danger btn-remove-from-library"
                                        data-bookshelf-id="{{ item.id }}"
                                        title="Remover">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-shelf" style="grid-column: 1 / -1;">
                            <i class="fas fa-trash-alt"></i>
                            <h4>Nenhum livro abandonado</h4>
                            <p>Continue suas leituras para n√£o precisar usar esta prateleira!</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Grids de Prateleiras Personalizadas (din√¢mico) -->
                {% for shelf in custom_shelves %}
                <div class="books-grid"
                     id="shelf-custom-{{ shelf.name }}"
                     data-custom-shelf="{{ shelf.name }}"
                     style="display: none;">
                    {% if shelf.books %}
                        {% for item in shelf.books %}
                        <div class="book-card"
                             data-bookshelf-id="{{ item.id }}"
                             data-notes="{{ item.notes|default:'' }}">
                            <a href="{% url 'core:book_detail' item.book.slug %}">
                                <div class="book-cover-container">
                                    {% if item.book.cover_image %}
                                    <img src="{{ item.book.cover_image.url }}"
                                         alt="{{ item.book.title }}"
                                         class="book-cover">
                                    {% else %}
                                    <img src="https://via.placeholder.com/160x240/6c757d/ffffff?text=Sem+Capa"
                                         alt="{{ item.book.title }}"
                                         class="book-cover">
                                    {% endif %}
                                </div>
                            </a>
                            <div class="book-title">{{ item.book.title|truncatewords:4 }}</div>
                            <div class="book-author">{{ item.book.author.name }}</div>
                            <div class="book-actions">
                                <button class="btn btn-sm btn-outline-danger btn-remove-from-library"
                                        data-bookshelf-id="{{ item.id }}"
                                        title="Remover">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-shelf" style="grid-column: 1 / -1;">
                            <i class="fas fa-folder"></i>
                            <h4>Prateleira vazia</h4>
                            <p>Adicione livros a "{{ shelf.name }}"!</p>
                            <a href="{% url 'core:book_list' %}" class="btn btn-primary mt-3">
                                Explorar Livros
                            </a>
                        </div>
                    {% endif %}
                </div>
                {% endfor %}

                <!-- Modal - Criar Prateleira Personalizada -->
                <div class="modal fade" id="libraryCustomShelfModal" tabindex="-1" aria-labelledby="libraryCustomShelfModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="libraryCustomShelfModalLabel">
                                    <i class="fas fa-folder-plus me-2"></i>Nova Prateleira Personalizada
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                            </div>
                            <div class="modal-body">
                                <form id="libraryCustomShelfForm">
                                    <div class="mb-3">
                                        <label for="libraryCustomShelfName" class="form-label">Nome da Prateleira</label>
                                        <input type="text"
                                               class="form-control"
                                               id="libraryCustomShelfName"
                                               placeholder="Ex: Fic√ß√£o Cient√≠fica Favorita"
                                               maxlength="100"
                                               required>
                                        <div class="form-text">M√°ximo 100 caracteres</div>
                                        <div id="libraryCustomShelfError" class="text-danger mt-2" style="display: none;"></div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </button>
                                <button type="button" class="btn btn-primary" id="libraryCreateCustomShelfBtn" onclick="createLibraryCustomShelf()">
                                    <i class="fas fa-check me-2"></i>Criar Prateleira
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal: Gerenciar Prateleiras -->
    <div class="modal fade" id="manageShelvesModal" tabindex="-1" aria-labelledby="manageShelvesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageShelvesModalLabel">
                        <i class="fas fa-cog me-2"></i>Gerenciar Minhas Prateleiras
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <!-- Tabs -->
                    <ul class="nav nav-tabs mb-3" id="manageTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="shelves-tab" data-bs-toggle="tab"
                                    data-bs-target="#shelves-panel" type="button" role="tab">
                                <i class="fas fa-folder me-2"></i>Minhas Prateleiras
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="books-tab" data-bs-toggle="tab"
                                    data-bs-target="#books-panel" type="button" role="tab">
                                <i class="fas fa-book me-2"></i>Gerenciar Livros
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content" id="manageTabsContent">
                        <!-- Aba 1: Minhas Prateleiras -->
                        <div class="tab-pane fade show active" id="shelves-panel" role="tabpanel">
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Gerencie suas prateleiras personalizadas.</strong>
                                Renomeie ou delete prateleiras. Ao deletar, todos os livros da prateleira ser√£o removidos.
                            </div>

                            <div id="shelves-list">
                                <!-- Lista ser√° preenchida via JavaScript -->
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Aba 2: Gerenciar Livros -->
                        <div class="tab-pane fade" id="books-panel" role="tabpanel">
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Gerencie os livros em suas prateleiras.</strong>
                                Selecione uma prateleira para ver e editar seus livros.
                            </div>

                            <!-- Seletor de Prateleira -->
                            <div class="mb-3">
                                <label for="select-shelf" class="form-label fw-bold">
                                    <i class="fas fa-folder-open me-2"></i>Selecione uma Prateleira:
                                </label>
                                <select class="form-select" id="select-shelf" onchange="loadShelfBooks(this.value)">
                                    <option value="">-- Escolha uma prateleira --</option>
                                    <optgroup label="Prateleiras Padr√£o">
                                        <option value="favorites">? Favoritos ({{ favorites_count }})</option>
                                        <option value="to_read">?? Quero Ler ({{ to_read_count }})</option>
                                        <option value="reading">?? Lendo ({{ reading_count }})</option>
                                        <option value="read">? Lidos ({{ read_count }})</option>
                                        <option value="abandoned">?? Abandonados ({{ abandoned_count }})</option>
                                    </optgroup>
                                    {% if custom_shelves %}
                                    <optgroup label="Prateleiras Personalizadas">
                                        {% for shelf in custom_shelves %}
                                        <option value="custom:{{ shelf.name }}">
                                            ?? {{ shelf.name }} ({{ shelf.count }})
                                        </option>
                                        {% endfor %}
                                    </optgroup>
                                    {% endif %}
                                </select>
                            </div>

                            <!-- Lista de Livros -->
                            <div id="books-list">
                                <div class="text-muted text-center py-4">
                                    <i class="fas fa-arrow-up fa-2x mb-2"></i>
                                    <p>Selecione uma prateleira acima para gerenciar seus livros.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% include 'core/widgets/background_modal.html' %}

</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    /**
     * Mostra modal de criar prateleira na biblioteca
     */
    function showLibraryCustomShelfModal() {
        // Limpar form
        document.getElementById('libraryCustomShelfName').value = '';
        document.getElementById('libraryCustomShelfError').style.display = 'none';

        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('libraryCustomShelfModal'));
        modal.show();

        // Focar no input
        setTimeout(() => {
            document.getElementById('libraryCustomShelfName').focus();
        }, 500);
    }

    /**
     * Cria prateleira personalizada na biblioteca
     */
    function createLibraryCustomShelf() {
        const nameInput = document.getElementById('libraryCustomShelfName');
        const errorDiv = document.getElementById('libraryCustomShelfError');
        const createBtn = document.getElementById('libraryCreateCustomShelfBtn');

        const customShelfName = nameInput.value.trim();

        // Valida√ß√£o
        if (!customShelfName) {
            errorDiv.textContent = 'Por favor, insira um nome para a prateleira.';
            errorDiv.style.display = 'block';
            nameInput.focus();
            return;
        }

        if (customShelfName.length > 100) {
            errorDiv.textContent = 'Nome muito longo (m√°ximo 100 caracteres).';
            errorDiv.style.display = 'block';
            return;
        }

        // Loading
        createBtn.disabled = true;
        createBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Criando...';
        errorDiv.style.display = 'none';

        // Criar prateleira
        LibraryManager.createCustomShelf(customShelfName)
            .then(data => {
                if (data.success) {
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('libraryCustomShelfModal'));
                    modal.hide();

                    // Recarregar p√°gina para mostrar nova prateleira
                    LibraryManager.showToast('Prateleira criada! Recarregando...', 'success', 1500);
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    // Mostrar erro
                    errorDiv.textContent = data.message;
                    errorDiv.style.display = 'block';
                }
            })
            .catch(error => {
                errorDiv.textContent = 'Erro ao criar prateleira. Tente novamente.';
                errorDiv.style.display = 'block';
            })
            .finally(() => {
                // Restaurar bot√£o
                createBtn.disabled = false;
                createBtn.innerHTML = '<i class="fas fa-check me-2"></i>Criar Prateleira';
            });
    }

    // Adicionar listener para Enter no form
    document.getElementById('libraryCustomShelfName')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            createLibraryCustomShelf();
        }
    });

    /**
     * Alterna entre prateleiras
     */
    // ‚ö° CORRE√á√ÉO: Expor fun√ß√£o no escopo global
    window.showShelf = function(shelfType, customName = '') {
        // Atualizar navega√ß√£o ativa
        document.querySelectorAll('.library-nav-item').forEach(item => {
            item.classList.remove('active');
        });

        const shelfKey = shelfType === 'custom' ? `custom-${customName}` : shelfType;
        const activeNav = document.querySelector(`[data-shelf="${shelfKey}"]`);
        if (activeNav) {
            activeNav.classList.add('active');
        }

        // Esconder todas as grids
        document.querySelectorAll('.books-grid').forEach(grid => {
            grid.style.display = 'none';
        });

        // Mostrar grid selecionada
        const targetGrid = document.getElementById(`shelf-${shelfKey}`);
        if (targetGrid) {
            targetGrid.style.display = 'grid';
        }

        // Atualizar header
        const titles = {
            'favorites': 'Favoritos',
            'to_read': 'Quero Ler',
            'reading': 'Lendo',
            'read': 'Lidos',
            'abandoned': 'Abandonados'
        };

        const counts = {
            'favorites': {{ favorites_count|default:0 }},
            'to_read': {{ to_read_count|default:0 }},
            'reading': {{ reading_count|default:0 }},
            'read': {{ read_count|default:0 }},
            'abandoned': {{ abandoned_count|default:0 }}
        };

        let shelfTitle = titles[shelfType] || customName;
        let shelfCount = counts[shelfType];

        // Se for custom, buscar count do data attribute
        if (shelfType === 'custom') {
            const countElement = activeNav?.querySelector('.count');
            shelfCount = countElement ? parseInt(countElement.textContent) : 0;
        }

        document.getElementById('shelf-title').textContent = shelfTitle;
        document.getElementById('shelf-count').textContent = shelfCount || 0;
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìö Biblioteca carregada');

        // Adicionar log para debug
        console.log('‚úÖ showShelf dispon√≠vel:', typeof window.showShelf);
    });
</script>

<!-- Background Manager JS -->
<script src="{% static 'js/background-manager.js' %}?v=2.0"></script>

<!-- Background Modal Functions -->
<script>
    function showBackgroundModal() {
        const modal = new bootstrap.Modal(document.getElementById('backgroundModal'));
        modal.show();
    }
</script>

{% include 'core/modals/add_book_modal.html' %}

<script src="{% static 'js/book-search.js' %}?v=1.0"></script>

<script>
    document.addEventListener('libraryUpdated', function(e) {
        console.log('Evento "libraryUpdated" recebido! A biblioteca ser√° atualizada.');

        if (window.LibraryManager && typeof window.LibraryManager.showToast === 'function') {
            window.LibraryManager.showToast('Biblioteca atualizada!', 'success', 1500);
        }

        const addBookModalEl = document.getElementById('addBookModal');
        if (addBookModalEl) {
            const modalInstance = bootstrap.Modal.getInstance(addBookModalEl);
            if (modalInstance) {
                modalInstance.hide();
            }
        }

        setTimeout(() => {
            window.location.reload();
        }, 1500);
    });
</script>
{% endblock %}