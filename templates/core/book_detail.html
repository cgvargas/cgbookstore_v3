{% extends 'base.html' %}
{% load static %}

{% block title %}{{ book.title }} - CGBookStore{% endblock %}

{% block extra_css %}
<style>
    /* Estilo do slider de progresso - específico para detail */
    .progress-slider-detail {
        cursor: pointer;
    }

    .progress-slider-detail::-webkit-slider-thumb {
        background: #198754;
        cursor: pointer;
    }

    .progress-slider-detail::-moz-range-thumb {
        background: #198754;
        cursor: pointer;
    }

    /* Alert compacto */
    .alert-sm {
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Início</a></li>
            <li class="breadcrumb-item"><a href="{% url 'core:book_list' %}">Livros</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ book.title }}</li>
        </ol>
    </nav>

    <!-- Detalhes do Livro -->
    <div class="row">
        <!-- Coluna da Capa -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm">
                {% if book.cover_image %}
                    <img src="{{ book.cover_image.url }}" class="card-img-top" alt="{{ book.title }}">
                {% else %}
                    <img src="https://via.placeholder.com/400x600/6c757d/ffffff?text=Sem+Capa"
                         class="card-img-top" alt="Sem capa">
                {% endif %}
            </div>

            <!-- Botões de Ação -->
            <div class="d-grid gap-2 mt-3">

                <!-- Botão de Compra no Parceiro -->
                {% if book.purchase_partner_url %}
                    <a href="{{ book.purchase_partner_url }}"
                       target="_blank"
                       rel="noopener noreferrer"
                       class="btn btn-success btn-lg">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Comprar na {{ book.purchase_partner_name|default:"loja parceira" }}
                        <i class="fas fa-external-link-alt ms-2"></i>
                    </a>
                {% else %}
                    <button class="btn btn-outline-secondary btn-lg" disabled>
                        <i class="fas fa-clock me-2"></i>
                        Em breve disponível para compra
                    </button>
                {% endif %}

                {% if user.is_authenticated %}
                    <!-- Container para botão de biblioteca -->
                    <div id="library-button-container">
                        <!-- Dropdown Button Group -->
                        <div class="btn-group w-100" role="group">
                            <button type="button"
                                    class="btn btn-primary btn-lg btn-add-to-library-main"
                                    data-book-id="{{ book.id }}"
                                    onclick="addToDefaultShelf({{ book.id }})">
                                <i class="fas fa-book-reader me-2"></i>
                                <span id="library-button-text">Adicionar à Biblioteca</span>
                            </button>
                            <button type="button"
                                    class="btn btn-primary btn-lg dropdown-toggle dropdown-toggle-split"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false">
                                <span class="visually-hidden">Escolher prateleira</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-scrollable">
                                <li><h6 class="dropdown-header">Adicionar a:</h6></li>

                                <!-- Prateleiras Padrão (4 fixas) -->
                                <li>
                                    <a class="dropdown-item" href="#" onclick="addToShelf({{ book.id }}, 'favorites'); return false;">
                                        <i class="fas fa-heart text-danger me-2"></i>Favoritos
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="addToShelf({{ book.id }}, 'to_read'); return false;">
                                        <i class="fas fa-bookmark text-primary me-2"></i>Quero Ler
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="addToShelf({{ book.id }}, 'reading'); return false;">
                                        <i class="fas fa-book-open text-success me-2"></i>Lendo
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="addToShelf({{ book.id }}, 'read'); return false;">
                                        <i class="fas fa-check-circle text-info me-2"></i>Lidos
                                    </a>
                                </li>

                                <!-- Prateleiras Personalizadas (dinâmicas) -->
                                {% if custom_shelves %}
                                    <li><hr class="dropdown-divider"></li>
                                    <li><h6 class="dropdown-header"><i class="fas fa-folder me-1"></i>Minhas Prateleiras:</h6></li>
                                    {% for shelf_name in custom_shelves %}
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="addToShelf({{ book.id }}, 'custom', '{{ shelf_name|escapejs }}'); return false;">
                                                <i class="fas fa-folder text-warning me-2"></i>{{ shelf_name }}
                                            </a>
                                        </li>
                                    {% endfor %}
                                {% endif %}

                                <!-- Opção de criar nova prateleira -->
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="showCustomShelfModal({{ book.id }}); return false;">
                                        <i class="fas fa-plus-circle text-warning me-2"></i>Nova Prateleira Personalizada
                                    </a>
                                </li>

                                <!-- Link para gerenciar biblioteca -->
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-muted" href="{% url 'core:library' %}">
                                        <i class="fas fa-cog me-2"></i>Gerenciar Biblioteca
                                    </a>
                                </li>
                            </ul>
                            <!-- Modal - Criar Prateleira Personalizada -->
                            <div class="modal fade" id="customShelfModal" tabindex="-1" aria-labelledby="customShelfModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="customShelfModalLabel">
                                                <i class="fas fa-folder-plus me-2"></i>Nova Prateleira Personalizada
                                            </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                                        </div>
                                        <div class="modal-body">
                                            <form id="customShelfForm">
                                                <div class="mb-3">
                                                    <label for="customShelfName" class="form-label">Nome da Prateleira</label>
                                                    <input type="text"
                                                           class="form-control"
                                                           id="customShelfName"
                                                           placeholder="Ex: Ficção Científica Favorita"
                                                           maxlength="100"
                                                           required>
                                                    <div class="form-text">Máximo 100 caracteres</div>
                                                    <div id="customShelfError" class="text-danger mt-2" style="display: none;"></div>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                <i class="fas fa-times me-2"></i>Cancelar
                                            </button>
                                            <button type="button" class="btn btn-primary" id="createCustomShelfBtn" onclick="createAndAddToCustomShelf()">
                                                <i class="fas fa-check me-2"></i>Criar e Adicionar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Indicador de prateleiras atuais -->
                        <div id="current-shelves-indicator" class="mt-2" style="display: none;">
                            <div class="alert alert-info py-2 px-3 mb-0">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    <strong>Já na biblioteca:</strong>
                                    <div id="current-shelves-list" class="mt-1"></div>
                                </small>
                            </div>
                        </div>

                        <!-- ⚡ NOVO: Widget de Progresso (apenas se estiver lendo) -->
                        {% if user_is_reading and reading_progress %}
                        <div class="card mt-4" id="readingProgressWidget"
                             data-book-id="{{ book.id }}"
                             data-deadline="{{ reading_progress.deadline|date:'Y-m-d'|default:'' }}">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-book-open me-2"></i>Seu Progresso de Leitura</h5>
                            </div>
                            <div class="card-body">
                                <p>Você está lendo este livro. Atualize seu progresso abaixo.</p>

                                <!-- Barra de Progresso Visual -->
                                <div class="progress mb-3" style="height: 20px;">
                                    <div id="progress-bar-inner" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                         role="progressbar" style="width: {{ reading_progress.percentage }}%;"
                                         aria-valuenow="{{ reading_progress.percentage }}" aria-valuemin="0" aria-valuemax="100">
                                         <strong id="progress-percentage">{{ reading_progress.percentage }}%</strong>
                                    </div>
                                </div>

                                <!-- Formulário de Atualização -->
                                <div class="row align-items-end">
                                    <div class="col-md-6 mb-3 mb-md-0">
                                        <label for="currentPage" class="form-label fw-bold">Página Atual:</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="currentPage"
                                                   value="{{ reading_progress.current_page }}"
                                                   min="0" max="{{ book.page_count }}">
                                            <span class="input-group-text">
                                                de <strong id="totalPages" class="ms-1">{{ book.page_count|default:reading_progress.total_pages }}</strong>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <button class="btn btn-success w-100" id="updateProgressBtn">
                                            <i class="fas fa-save me-2"></i>Salvar Progresso
                                        </button>
                                    </div>
                                </div>

                                <hr class="my-3">

                                <!-- Gerenciamento de Prazo -->
                                <div class="d-flex justify-content-between align-items-center">
                                    <div id="deadline-display" class="text-muted">
                                        {% if reading_progress.deadline %}
                                            <strong>Prazo:</strong> {{ reading_progress.deadline|date:"d/m/Y" }}
                                        {% else %}
                                            <span>Nenhum prazo definido.</span>
                                        {% endif %}
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm" id="setDeadlineBtn">
                                        <i class="fas fa-calendar-alt me-2"></i>
                                        {% if reading_progress.deadline %}Alterar Prazo{% else %}Definir Prazo{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                {% else %}
                    <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-sign-in-alt me-2"></i>Entrar para Adicionar
                    </a>
                {% endif %}

                {% if book.preview_link %}
                    <a href="{{ book.preview_link }}" target="_blank" class="btn btn-outline-secondary">
                        <i class="fas fa-external-link-alt me-2"></i>Visualizar no Google Books
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- Coluna de Informações -->
        <div class="col-md-8">
            <!-- Título e Subtítulo -->
            <h1 class="display-5 fw-bold">{{ book.title }}</h1>
            {% if book.subtitle %}
                <h2 class="h4 text-muted mb-3">{{ book.subtitle }}</h2>
            {% endif %}

            <!-- Autor -->
            <p class="lead">
                <i class="fas fa-user me-2"></i>
                <strong>Por:</strong> {{ book.author.name }}
            </p>

            <!-- Avaliação (se houver) -->
            {% if book.average_rating %}
                <div class="mb-3">
                    <div class="d-flex align-items-center">
                        <div class="me-2">
                            {% for i in "12345" %}
                                {% if forloop.counter <= book.rating_stars %}
                                    <i class="fas fa-star text-warning"></i>
                                {% else %}
                                    <i class="far fa-star text-warning"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <span class="text-muted">
                            {{ book.average_rating }}
                            {% if book.ratings_count %}
                                ({{ book.ratings_count }} avaliações)
                            {% endif %}
                        </span>
                    </div>
                </div>
            {% endif %}

            <!-- Categoria -->
            {% if book.category %}
                <p>
                    <i class="fas fa-tag me-2"></i>
                    <strong>Categoria:</strong>
                    <span class="badge bg-primary">{{ book.category.name }}</span>
                </p>
            {% endif %}

            <hr>

            <!-- Detalhes em Grid -->
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">
                                <i class="fas fa-building me-2"></i>Editora
                            </h6>
                            <p class="card-text mb-0">{{ book.publisher|default:"Não informado" }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">
                                <i class="fas fa-calendar-alt me-2"></i>Publicação
                            </h6>
                            <p class="card-text mb-0">{{ book.publication_date|date:"Y"|default:"Não informado" }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">
                                <i class="fas fa-file-alt me-2"></i>Páginas
                            </h6>
                            <p class="card-text mb-0">{{ book.page_count|default:"Não informado" }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">
                                <i class="fas fa-globe me-2"></i>Idioma
                            </h6>
                            <p class="card-text mb-0">{{ book.language|default:"Não informado" }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">
                                <i class="fas fa-barcode me-2"></i>ISBN-13
                            </h6>
                            <p class="card-text mb-0">
                                {% if book.isbn %}
                                    {{ book.isbn }}
                                {% else %}
                                    <span class="text-muted">Não informado</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">
                                <i class="fas fa-tag me-2"></i>Preço Médio
                            </h6>
                            <p class="card-text mb-0 fs-4 fw-bold">
                                {% if book.price %}
                                    R$ {{ book.price|floatformat:2 }}
                                {% else %}
                                    <span class="text-muted">Consulte-nos</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Descrição -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-info-circle me-2"></i>Sobre este livro
                    </h5>
                    <p class="card-text">{{ book.description|linebreaks }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Livros Relacionados -->
    {% if related_books %}
    <hr class="my-5">
    <h3 class="mb-4">
        <i class="fas fa-book me-2"></i>Livros Relacionados
    </h3>
    <div class="row">
        {% for related_book in related_books %}
        <div class="col-md-3 mb-4">
            <div class="card h-100 shadow-sm">
                {% if related_book.cover_image %}
                    <img src="{{ related_book.cover_image.url }}" class="card-img-top" alt="{{ related_book.title }}">
                {% else %}
                    <img src="https://via.placeholder.com/300x450/6c757d/ffffff?text=Sem+Capa"
                         class="card-img-top" alt="Sem capa">
                {% endif %}
                <div class="card-body">
                    <h6 class="card-title">{{ related_book.title|truncatewords:5 }}</h6>
                    <p class="card-text text-muted small">{{ related_book.author.name }}</p>
                    <a href="{% url 'core:book_detail' related_book.slug %}" class="btn btn-sm btn-outline-primary w-100">
                        Ver Detalhes
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
{% endblock %}