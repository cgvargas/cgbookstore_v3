{% load static %}

<!--
    Seção de Recomendações Personalizadas - SIMPLIFICADO
    Versão: 3.0 (Sistema Único - Sem IA)
    Última atualização: 2025-11-27
    Cache-Buster: v3-no-buttons-20251127
-->
<!-- Seção de Recomendações Personalizadas -->
<section class="recommendations-section my-5" id="recommendations-for-you">
    <div class="container">
        <div class="mb-4">
            <h2 class="section-title">
                <i class="fas fa-star me-2"></i>
                Recomendações Para Você
            </h2>
            <p class="text-muted small mb-0">
                Baseado nas suas prateleiras (Favoritos, Lidos, Lendo e Quer Ler)
            </p>
        </div>

        {% if user.is_authenticated %}
        <!-- Recomendações Personalizadas -->
        <div id="recommendations-container" class="row">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando recomendações...</span>
                </div>
                <p class="mt-3 text-muted">Analisando suas preferências...</p>
            </div>
        </div>


        {% else %}
        <!-- Mensagem para usuários não autenticados -->
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Faça login</strong> para receber recomendações personalizadas baseadas em suas preferências!
            <a href="{% url 'account_login' %}" class="alert-link">Entrar agora</a>
        </div>
        {% endif %}
    </div>
</section>

<style>
.recommendations-section {
    background: linear-gradient(to bottom, transparent, rgba(102, 126, 234, 0.05));
    padding: 2rem 0;
}

.section-title {
    font-weight: 700;
    color: var(--primary-color, #667eea);
}

.recommendation-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    height: 100%;
}

.recommendation-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.recommendation-reason {
    font-size: 0.85rem;
    color: #6c757d;
    font-style: italic;
    margin-top: 0.5rem;
}

.recommendation-score {
    position: absolute;
    top: 10px;
    right: 10px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
}

.btn-group .btn {
    font-size: 0.85rem;
}

.btn-group .btn i {
    font-size: 0.9rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if user.is_authenticated %}
    // LAZY-LOAD: Recomendações só carregam quando a seção for visível
    // Isso evita bloquear o LCP da página enquanto a API está lenta
    const section = document.getElementById('recommendations-for-you');
    if (section) {
        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // Seção visível, carregar recomendações
                    loadRecommendations();
                    // Parar de observar após carregar
                    observer.unobserve(entry.target);
                }
            });
        }, {
            root: null,
            rootMargin: '200px', // Carrega 200px antes de aparecer
            threshold: 0.1
        });
        observer.observe(section);
    }
    {% endif %}
});

function loadRecommendations() {
    const container = document.getElementById('recommendations-container');
    const startTime = performance.now();

    container.innerHTML = `
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-3 text-muted">Gerando recomendações...</p>
        </div>
    `;

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000);

    fetch(`/recommendations/api/recommendations/?limit=6`, {
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        signal: controller.signal
    })
        .then(response => {
            clearTimeout(timeoutId);
            if (!response.ok) {
                throw new Error('Erro ao carregar recomendações');
            }
            return response.json();
        })
        .then(data => {
            if (data.recommendations && data.recommendations.length > 0) {
                renderRecommendations(data.recommendations);
            } else {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Ainda não temos recomendações para você.</p>
                        <p class="text-muted">Comece interagindo com livros para receber sugestões personalizadas!</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            clearTimeout(timeoutId);
            console.error('Erro ao carregar recomendações:', error);

            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <p class="text-muted">Erro ao carregar recomendações. Tente novamente.</p>
                </div>
            `;
        });
}

function renderRecommendations(recommendations) {
    const container = document.getElementById('recommendations-container');
    let html = '';

    recommendations.forEach(rec => {
        const score = Math.round(rec.score * 100);
        const bookTitle = rec.title || 'Título não disponível';
        const bookAuthor = rec.author || 'Autor desconhecido';
        const bookCover = rec.cover_image || '/static/images/placeholder-book.png';
        const bookSlug = rec.slug;
        const bookReason = rec.reason || 'Recomendado para você';

        const shortReason = bookReason.length > 120
            ? bookReason.substring(0, 117) + '...'
            : bookReason;

        html += `
            <div class="col-md-4 col-lg-2 mb-4">
                <div class="card recommendation-card h-100">
                    <span class="recommendation-score">${score}%</span>
                    <img src="${bookCover}" class="card-img-top" alt="${bookTitle}"
                         style="height: 250px; object-fit: cover;"
                         onerror="this.src='{% static 'images/no-cover-placeholder.svg' %}';">
                    <div class="card-body d-flex flex-column">
                        <h6 class="card-title text-truncate" title="${bookTitle}">${bookTitle}</h6>
                        <p class="card-text text-muted small mb-2">${bookAuthor}</p>
                        <p class="recommendation-reason small flex-grow-1">${shortReason}</p>
                        <a href="/livros/${bookSlug}/"
                           class="btn btn-sm btn-primary w-100 mt-2 recommendation-link"
                           data-book-id="${rec.id}"
                           data-book-title="${bookTitle}"
                           onclick="trackRecommendationClick(event, this)">
                            <i class="fas fa-eye me-1"></i> Ver livro
                        </a>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

// Função para rastrear cliques em recomendações
function trackRecommendationClick(event, element) {
    const bookId = element.dataset.bookId;
    const bookTitle = element.dataset.bookTitle;

    fetch('/recommendations/api/track-click/', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            book_id: bookId,
            book_title: bookTitle,
            algorithm: 'simple_unified'
        })
    })
    .then(response => response.json())
    .then(data => console.log('Click tracked:', data))
    .catch(error => console.error('Error tracking click:', error));

    return true;
}

// Função auxiliar para obter CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
