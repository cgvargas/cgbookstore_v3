{% load static %}

<!-- Se√ß√£o de Recomenda√ß√µes Personalizadas -->
<section class="recommendations-section my-5" id="recommendations-for-you">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="section-title">
                <i class="fas fa-magic me-2"></i>
                Para Voc√™
            </h2>
            {% if user.is_authenticated %}
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline-primary active" data-algorithm="preference_hybrid" title="Recomenda√ß√µes ponderadas pelas suas prateleiras (Favoritos > Lidos > Lendo > Quero Ler)">
                    <i class="fas fa-star"></i> Personalizado
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary" data-algorithm="ai" title="Recomenda√ß√µes potencializadas com IA Gemini + Google Books">
                    <i class="fas fa-robot"></i> IA Premium
                </button>
                <!-- Algoritmos temporariamente desabilitados (muito lentos sem cache Redis) -->
                <!--
                <button type="button" class="btn btn-sm btn-outline-primary" data-algorithm="hybrid" title="Sistema h√≠brido cl√°ssico">
                    <i class="fas fa-blender"></i> H√≠brido
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary" data-algorithm="collaborative" title="Baseado em usu√°rios com gostos similares">
                    <i class="fas fa-users"></i> Similares
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary" data-algorithm="content" title="Baseado no conte√∫do dos livros que voc√™ gosta">
                    <i class="fas fa-book"></i> Conte√∫do
                </button>
                -->
            </div>
            {% endif %}
        </div>

        {% if user.is_authenticated %}
        <!-- Recomenda√ß√µes Personalizadas -->
        <div id="recommendations-container" class="row">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando recomenda√ß√µes...</span>
                </div>
                <p class="mt-3 text-muted">Analisando suas prefer√™ncias...</p>
            </div>
        </div>

        <!-- Insights do Usu√°rio (opcional) -->
        <div id="user-insights" class="mt-4" style="display:none;">
            <div class="card bg-light">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-lightbulb text-warning me-2"></i>
                        Insights sobre sua leitura
                    </h5>
                    <div id="insights-content"></div>
                </div>
            </div>
        </div>

        {% else %}
        <!-- Mensagem para usu√°rios n√£o autenticados -->
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Fa√ßa login</strong> para receber recomenda√ß√µes personalizadas baseadas em suas prefer√™ncias!
            <a href="{% url 'account_login' %}" class="alert-link">Entrar agora</a>
        </div>
        {% endif %}
    </div>
</section>

<style>
.recommendations-section {
    background: linear-gradient(to bottom, transparent, rgba(102, 126, 234, 0.05));
    padding: 2rem 0;
}

.section-title {
    font-weight: 700;
    color: var(--primary-color, #667eea);
}

.recommendation-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    height: 100%;
}

.recommendation-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.recommendation-reason {
    font-size: 0.85rem;
    color: #6c757d;
    font-style: italic;
    margin-top: 0.5rem;
}

.recommendation-score {
    position: absolute;
    top: 10px;
    right: 10px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
}

.btn-group .btn {
    font-size: 0.85rem;
}

.btn-group .btn i {
    font-size: 0.9rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if user.is_authenticated %}
    // Carregar recomenda√ß√µes ap√≥s a p√°gina estar pronta (evita bloquear renderiza√ß√£o)
    // Delay de 100ms permite que a p√°gina renderize completamente primeiro
    setTimeout(() => {
        loadRecommendations('preference_hybrid');
    }, 100);

    // Event listeners para trocar de algoritmo
    document.querySelectorAll('[data-algorithm]').forEach(button => {
        button.addEventListener('click', function() {
            // Atualizar bot√µes ativos
            document.querySelectorAll('[data-algorithm]').forEach(btn => {
                btn.classList.remove('active');
            });
            this.classList.add('active');

            // Carregar recomenda√ß√µes
            const algorithm = this.dataset.algorithm;
            loadRecommendations(algorithm);
        });
    });
    {% endif %}
});

function loadRecommendations(algorithm) {
    const container = document.getElementById('recommendations-container');

    // Marcar tempo de in√≠cio para feedback de performance
    const startTime = performance.now();

    // Mostrar loading com mensagem espec√≠fica para IA
    const loadingMessage = algorithm === 'ai'
        ? 'Consultando IA... Isso pode levar alguns segundos na primeira vez ü§ñ'
        : `Gerando recomenda√ß√µes...`;

    container.innerHTML = `
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-3 text-muted">${loadingMessage}</p>
            ${algorithm === 'ai' ? '<p class="small text-muted">(Pr√≥ximas requisi√ß√µes ser√£o instant√¢neas gra√ßas ao cache!)</p>' : ''}
        </div>
    `;

    // Fazer request para a API com timeout adequado:
    // - 30 segundos para IA (primeira chamada pode ser lenta)
    // - 10 segundos para outros algoritmos
    const controller = new AbortController();
    const timeoutDuration = algorithm === 'ai' ? 30000 : 10000;
    const timeoutId = setTimeout(() => controller.abort(), timeoutDuration);

    fetch(`/recommendations/api/recommendations/?algorithm=${algorithm}&limit=6`, {
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        signal: controller.signal
    })
        .then(response => {
            clearTimeout(timeoutId);
            if (!response.ok) {
                throw new Error('Erro ao carregar recomenda√ß√µes');
            }
            return response.json();
        })
        .then(data => {
            const loadTime = ((performance.now() - startTime) / 1000).toFixed(2);
            const isFastLoad = loadTime < 1.0; // Menos de 1s = provavelmente cache

            if (data.recommendations && data.recommendations.length > 0) {
                renderRecommendations(data.recommendations, algorithm, loadTime, isFastLoad);
            } else {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Ainda n√£o temos recomenda√ß√µes para voc√™.</p>
                        <p class="text-muted">Comece interagindo com livros para receber sugest√µes personalizadas!</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            clearTimeout(timeoutId);
            console.error('Erro ao carregar recomenda√ß√µes:', error);

            // Mensagem diferente para timeout vs erro de servidor
            const isTimeout = error.name === 'AbortError';
            const errorMessage = isTimeout
                ? 'Tempo esgotado ao buscar recomenda√ß√µes.'
                : 'Erro ao carregar recomenda√ß√µes. Tente novamente.';

            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <p class="text-muted">${errorMessage}</p>
                    ${isTimeout ? '<p class="small text-muted">O servi√ßo pode estar sobrecarregado. Tente novamente em alguns segundos.</p>' : ''}
                    <p class="small text-muted">Se o problema persistir, verifique se o Redis est√° rodando.</p>
                </div>
            `;
        });
}

function renderRecommendations(recommendations, algorithm, loadTime, isFastLoad) {
    const container = document.getElementById('recommendations-container');

    // Banner de performance/cache no topo
    let html = '';
    if (isFastLoad && algorithm === 'ai') {
        html += `
            <div class="col-12 mb-3">
                <div class="alert alert-success alert-dismissible fade show d-flex align-items-center" role="alert">
                    <i class="fas fa-bolt me-2"></i>
                    <div>
                        <strong>Cache ativo!</strong> Recomenda√ß√µes carregadas em ${loadTime}s.
                        <small class="text-muted">(Cache v√°lido por 1 hora)</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        `;
    } else if (!isFastLoad && algorithm === 'ai') {
        html += `
            <div class="col-12 mb-3">
                <div class="alert alert-info alert-dismissible fade show d-flex align-items-center" role="alert">
                    <i class="fas fa-robot me-2"></i>
                    <div>
                        <strong>IA consultada!</strong> Recomenda√ß√µes geradas em ${loadTime}s.
                        <small class="text-muted">(Pr√≥xima consulta ser√° instant√¢nea!)</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        `;
    }

    recommendations.forEach(rec => {
        const score = Math.round(rec.score * 100);
        const bookTitle = rec.title || 'T√≠tulo n√£o dispon√≠vel';
        const bookAuthor = rec.author || 'Autor desconhecido';
        const bookCover = rec.cover_image || '/static/images/placeholder-book.png';
        const bookSlug = rec.slug;
        const bookDescription = rec.description || rec.reason || 'Recomendado para voc√™';
        const googleBooksId = rec.google_books_id;
        const source = rec.source || 'local_db';

        // Truncar descri√ß√£o se muito longa
        const shortDesc = bookDescription.length > 120
            ? bookDescription.substring(0, 117) + '...'
            : bookDescription;

        html += `
            <div class="col-md-4 col-lg-2 mb-4">
                <div class="card recommendation-card h-100">
                    <span class="recommendation-score">${score}%</span>
                    ${source === 'google_books' ? `
                        <span class="badge bg-info position-absolute top-0 start-0 m-2"
                              style="z-index: 10; font-size: 0.65rem;">
                            <i class="fas fa-globe"></i> Novo
                        </span>
                    ` : ''}
                    <img src="${bookCover}" class="card-img-top" alt="${bookTitle}"
                         style="height: 250px; object-fit: cover;"
                         onerror="this.src='{% static 'images/no-cover-placeholder.svg' %}';">
                    <div class="card-body d-flex flex-column">
                        <h6 class="card-title text-truncate" title="${bookTitle}">${bookTitle}</h6>
                        <p class="card-text text-muted small mb-2">${bookAuthor}</p>
                        <p class="recommendation-reason small flex-grow-1">${shortDesc}</p>
                        ${bookSlug ? `
                            <a href="/livros/${bookSlug}/"
                               class="btn btn-sm btn-primary w-100 mt-2 recommendation-link"
                               data-book-id="${rec.id}"
                               data-book-title="${bookTitle}"
                               data-algorithm="${algorithm}"
                               data-source="${source}"
                               onclick="trackRecommendationClick(event, this)">
                                <i class="fas fa-eye me-1"></i> Ver livro
                            </a>
                        ` : googleBooksId ? `
                            <a href="https://books.google.com/books?id=${googleBooksId}"
                               target="_blank"
                               class="btn btn-sm btn-success w-100 mt-2 recommendation-link"
                               data-book-id=""
                               data-book-title="${bookTitle}"
                               data-algorithm="${algorithm}"
                               data-source="${source}"
                               onclick="trackRecommendationClick(event, this)">
                                <i class="fas fa-external-link-alt me-1"></i> Ver no Google Books
                            </a>
                        ` : `
                            <button class="btn btn-sm btn-outline-secondary w-100 mt-2" disabled>
                                <i class="fas fa-book me-1"></i> Indispon√≠vel
                            </button>
                        `}
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

// Fun√ß√£o para rastrear cliques em recomenda√ß√µes
function trackRecommendationClick(event, element) {
    const bookId = element.dataset.bookId || null;
    const bookTitle = element.dataset.bookTitle;
    const algorithm = element.dataset.algorithm;
    const source = element.dataset.source;

    // Enviar tracking de forma ass√≠ncrona (n√£o bloqueia navega√ß√£o)
    fetch('/recommendations/api/track-click/', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            book_id: bookId,
            book_title: bookTitle,
            algorithm: algorithm,
            source: source
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Click tracked:', data);
    })
    .catch(error => {
        console.error('Error tracking click:', error);
    });

    // Permitir navega√ß√£o normal
    return true;
}

// Fun√ß√£o auxiliar para obter CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
