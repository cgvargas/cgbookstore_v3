# CGBookStore v3 - Documento de Estado do Projeto

**Data:** 12/10/2025 - 11:30  
**VersÃ£o:** 8.0  
**Ãšltima AtualizaÃ§Ã£o:** Sistema de Prateleiras Personalizadas com Lista no Profile

---

## ğŸ¯ VisÃ£o Geral do Projeto

**CGBookStore v3** Ã© uma livraria online desenvolvida em Django 5.0.3 com PostgreSQL (Supabase), focada em proporcionar uma experiÃªncia completa de leitura com biblioteca pessoal gamificada, sistema de prateleiras personalizadas, integraÃ§Ã£o com Google Books API, Supabase Storage e dashboard administrativa moderna.

### Tecnologias Principais
- **Backend:** Django 5.0.3
- **Banco de Dados:** PostgreSQL 17.6 (Supabase) - Transaction Mode (porta 6543)
- **Storage:** Supabase Storage (3 buckets pÃºblicos: book-covers, author-photos, user-avatars)
- **Python:** 3.13
- **Frontend:** Bootstrap 5, Font Awesome, Swiper.js
- **APIs:** Google Books API - INTEGRADO
- **Controle de VersÃ£o:** Git + GitHub

---

## ğŸ“ ESTADO ATUAL - Em Desenvolvimento

### ğŸš§ Branch: `main`
**Status:** Up to date with `origin/main`

### ğŸ“ Arquivos Modificados (NÃ£o Staged):
```
modified:   accounts/models/user_profile.py
modified:   core/views/library_ajax_views.py
modified:   core/views/library_view.py
```

### ğŸ“„ Arquivos Novos (Untracked):
```
accounts/migrations/0004_userprofile_custom_shelves_list.py
```

### âš ï¸ IMPORTANTE: MudanÃ§as Pendentes de Commit
**NÃƒO fazer push antes de testar tudo!**

---

## ğŸ”¥ O QUE FOI IMPLEMENTADO HOJE (12/10/2025)

### **1. Signal para Auto-CriaÃ§Ã£o de UserProfile** âœ… COMPLETO
- **Criado:** `accounts/signals.py`
- **Modificado:** `accounts/apps.py`
- **Funcionalidade:** UserProfile Ã© criado automaticamente quando um User Ã© registrado
- **Testado:** âœ… Funcionando
- **Committado:** âœ… Sim

### **2. CorreÃ§Ã£o de Admin - RemoÃ§Ã£o de SectionItemAdmin** âœ… COMPLETO
- **Modificados:** `core/admin/__init__.py`, `core/admin/section_admin.py`
- **Problema Resolvido:** Duplicate key error em SectionItem
- **SoluÃ§Ã£o:** Removido admin separado, mantido apenas inline
- **Testado:** âœ… Funcionando
- **Committado:** âœ… Sim

### **3. Sistema de GamificaÃ§Ã£o em BookShelf** âœ… COMPLETO
- **Modificado:** `accounts/models/book_shelf.py`
- **CorreÃ§Ãµes:**
  - `add_points()` â†’ `add_xp()` (mÃ©todo correto)
  - `book.pages` â†’ `book.page_count` (campo correto)
- **Funcionalidade:** 
  - 10 XP por livro lido
  - Incrementa `books_read_count`
  - Incrementa `total_pages_read`
  - Atualiza `streak_days`
- **Testado:** âœ… Funcionando (livro adicionado, XP creditado)
- **Committado:** âœ… Sim

### **4. Sistema de Prateleiras Personalizadas com Lista** ğŸš§ EM IMPLEMENTAÃ‡ÃƒO
**Problema identificado:**
- Prateleiras personalizadas sÃ³ apareciam APÃ“S adicionar um livro
- UX ruim: usuÃ¡rio cria prateleira, nÃ£o vÃª na sidebar, fica confuso

**SoluÃ§Ã£o implementada:**
- Campo `custom_shelves_list` (JSONField) no UserProfile
- Armazena lista de nomes: `['Meus ClÃ¡ssicos', 'FicÃ§Ã£o Favorita']`
- View pega lista do profile e faz left join com BookShelf
- Prateleiras vazias aparecem com count=0

**Arquivos modificados:**

#### **A) `accounts/models/user_profile.py`** ğŸŸ¡ MODIFICADO (nÃ£o staged)
**Adicionado:**
- Campo `custom_shelves_list = JSONField(default=list)` (apÃ³s linha ~117, depois de `badges`)
- MÃ©todo `add_custom_shelf(shelf_name)` - Adiciona prateleira Ã  lista
- MÃ©todo `remove_custom_shelf(shelf_name)` - Remove prateleira
- MÃ©todo `has_custom_shelf(shelf_name)` - Verifica existÃªncia
- MÃ©todo `get_custom_shelves()` - Retorna lista ordenada

#### **B) `accounts/migrations/0004_userprofile_custom_shelves_list.py`** ğŸ†• CRIADO (nÃ£o staged)
**Migration gerada:**
```python
operations = [
    migrations.AddField(
        model_name='userprofile',
        name='custom_shelves_list',
        field=models.JSONField(blank=True, default=list, ...),
    ),
]
```

**Status da Migration:**
- âœ… Arquivo gerado (`makemigrations` executado)
- â³ **PENDENTE:** Rodar `migrate` para aplicar no banco
- âš ï¸ **NÃƒO APLICADA AINDA**

#### **C) `core/views/library_ajax_views.py`** ğŸŸ¡ MODIFICADO (nÃ£o staged)
**FunÃ§Ã£o atualizada:** `create_custom_shelf()` (linha ~235)

**MudanÃ§as:**
```python
# ANTES:
# Validava apenas, nÃ£o salvava em lugar nenhum

# DEPOIS:
profile = request.user.profile
if profile.has_custom_shelf(custom_shelf_name):
    return erro
profile.add_custom_shelf(custom_shelf_name)  # â† SALVA NA LISTA
```

#### **D) `core/views/library_view.py`** ğŸŸ¡ MODIFICADO (nÃ£o staged)
**SeÃ§Ã£o atualizada:** Prateleiras Personalizadas (linhas ~65-85)

**MudanÃ§as:**
```python
# ANTES:
custom_shelves_data = BookShelf.objects.filter(
    user=user, shelf_type='custom'
).values('custom_shelf_name').annotate(count=Count('id'))
# â†‘ SÃ³ retornava prateleiras COM livros

# DEPOIS:
if profile:
    shelf_names = profile.get_custom_shelves()  # â† Pega TODAS
    for shelf_name in shelf_names:
        books = BookShelf.objects.filter(...)  # Left join
        custom_shelves_list.append({
            'name': shelf_name,
            'count': books.count(),  # â† Pode ser 0
            'books': books
        })
```

---

## ğŸ§ª STATUS DE TESTES

### âœ… Testado e Funcionando:
- [x] Signal cria UserProfile automaticamente
- [x] Adicionar livro Ã  biblioteca (prateleiras padrÃ£o)
- [x] GamificaÃ§Ã£o: XP, books_read_count, total_pages_read, streak
- [x] Admin sem erro de duplicate key

### â³ Aguardando Teste (ImplementaÃ§Ã£o Completa):
- [ ] **Migration aplicada** (`migrate accounts`)
- [ ] Criar prateleira personalizada via `/biblioteca/`
- [ ] Prateleira vazia aparece na sidebar
- [ ] Adicionar livro Ã  prateleira personalizada
- [ ] Count atualiza corretamente
- [ ] PersistÃªncia entre devices

---

## ğŸ¯ PRÃ“XIMOS PASSOS - CHECKLIST DE IMPLEMENTAÃ‡ÃƒO

### **PASSO 1: Aplicar Migration** âš ï¸ CRÃTICO
```powershell
cd C:\ProjectDjango\cgbookstore_v3
.\.venv\Scripts\Activate.ps1

# Aplicar migration
python manage.py migrate accounts

# Esperado:
# Applying accounts.0004_userprofile_custom_shelves_list... OK
```

**Por que Ã© crÃ­tico?**
- UserProfile no banco NÃƒO tem o campo `custom_shelves_list` ainda
- Views tentam usar `profile.get_custom_shelves()` â†’ AttributeError
- Servidor pode quebrar ao acessar `/biblioteca/`

---

### **PASSO 2: Testar CriaÃ§Ã£o de Prateleira**

```powershell
# Iniciar servidor
python manage.py runserver
```

**No navegador:**
1. Acessar: `http://127.0.0.1:8000/biblioteca/`
2. Clicar "Nova Prateleira" (botÃ£o na sidebar)
3. Nome: "Meus ClÃ¡ssicos"
4. Clicar "Criar Prateleira"
5. **âœ… Esperado:** Prateleira aparece IMEDIATAMENTE na sidebar (count: 0)

**Se der erro:**
- Ver console do servidor (traceback)
- Ver DevTools F12 â†’ Console (erros JS)
- Ver DevTools â†’ Network â†’ Response da requisiÃ§Ã£o

---

### **PASSO 3: Testar Adicionar Livro**

1. Ir em qualquer livro: `http://127.0.0.1:8000/livros/o-problema-dos-tres-corpos/`
2. "Adicionar Ã  Biblioteca" â†’ Selecionar "Meus ClÃ¡ssicos"
3. Voltar em `/biblioteca/`
4. **âœ… Esperado:** Prateleira mostra count=1, livro aparece

---

### **PASSO 4: Verificar PersistÃªncia (Shell)**

```powershell
python manage.py shell
```

```python
from django.contrib.auth.models import User

# Pegar admin
user = User.objects.get(username='admin')
profile = user.profile

# Ver prateleiras
print(f"Prateleiras: {profile.custom_shelves_list}")
# Esperado: ['Meus ClÃ¡ssicos']

# Testar mÃ©todos
print(f"Tem 'Meus ClÃ¡ssicos'? {profile.has_custom_shelf('Meus ClÃ¡ssicos')}")
# Esperado: True

# Ver todas ordenadas
print(f"Todas: {profile.get_custom_shelves()}")
# Esperado: ['Meus ClÃ¡ssicos']

exit()
```

---

### **PASSO 5: Commit e Push**

**Se TODOS os testes passarem:**

```powershell
git status

git add accounts/models/user_profile.py
git add accounts/migrations/0004_userprofile_custom_shelves_list.py
git add core/views/library_ajax_views.py
git add core/views/library_view.py

git commit -m "Feat: Prateleiras personalizadas aparecem mesmo vazias

Problema:
- Prateleiras sÃ³ apareciam apÃ³s adicionar livro
- UsuÃ¡rio confuso (criou mas nÃ£o vÃª)
- UX ruim

SoluÃ§Ã£o:
- Campo custom_shelves_list (JSONField) no UserProfile
- Armazena lista de nomes de prateleiras
- View pega lista e faz left join com BookShelf
- Prateleiras vazias aparecem com count=0

Migration:
- 0004_userprofile_custom_shelves_list

MÃ©todos UserProfile:
- add_custom_shelf(name) - Adiciona Ã  lista
- remove_custom_shelf(name) - Remove da lista
- has_custom_shelf(name) - Verifica existÃªncia
- get_custom_shelves() - Retorna lista ordenada

Views Atualizadas:
- library_ajax_views.create_custom_shelf() - Salva no profile
- library_view.LibraryView - Mostra todas (vazias ou nÃ£o)

Testes:
- Criar prateleira â†’ aparece imediatamente âœ…
- Adicionar livro â†’ contador atualiza âœ…
- PersistÃªncia entre devices âœ…
- Shell confirma dados no profile âœ…"

git push origin main
```

---

## ğŸ“‚ Estrutura Atual do Projeto

```
C:\ProjectDjango\cgbookstore_v3\
â”œâ”€â”€ cgbookstore/              # ConfiguraÃ§Ãµes do projeto
â”‚   â”œâ”€â”€ settings.py           # Supabase Transaction Mode + Storage
â”‚   â”œâ”€â”€ urls.py
â”‚   â””â”€â”€ wsgi.py
â”‚
â”œâ”€â”€ core/                     # App principal (livraria)
â”‚   â”œâ”€â”€ models/               # MODULAR
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ category.py
â”‚   â”‚   â”œâ”€â”€ author.py
â”‚   â”‚   â”œâ”€â”€ book.py          # Campo: page_count
â”‚   â”‚   â”œâ”€â”€ video.py
â”‚   â”‚   â”œâ”€â”€ section.py
â”‚   â”‚   â”œâ”€â”€ section_item.py
â”‚   â”‚   â””â”€â”€ event.py
â”‚   â”‚
â”‚   â”œâ”€â”€ admin/                # ADMIN MODULAR
â”‚   â”‚   â”œâ”€â”€ __init__.py      # ğŸŸ¢ SectionItemAdmin removido
â”‚   â”‚   â”œâ”€â”€ section_admin.py # ğŸŸ¢ Classe SectionItemAdmin deletada
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ views/                # MODULAR
â”‚   â”‚   â”œâ”€â”€ library_view.py           # ğŸŸ¡ MODIFICADO (prateleiras vazias)
â”‚   â”‚   â”œâ”€â”€ library_ajax_views.py     # ğŸŸ¡ MODIFICADO (salva no profile)
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ storage_backends.py   # Supabase Storage
â”‚   â””â”€â”€ urls.py
â”‚
â”œâ”€â”€ accounts/                 # App de autenticaÃ§Ã£o
â”‚   â”œâ”€â”€ models/               # MODULAR
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user_profile.py   # ğŸŸ¡ MODIFICADO (campo + mÃ©todos)
â”‚   â”‚   â”œâ”€â”€ book_shelf.py     # ğŸŸ¢ GamificaÃ§Ã£o funcionando
â”‚   â”‚   â”œâ”€â”€ reading_progress.py
â”‚   â”‚   â””â”€â”€ book_review.py
â”‚   â”‚
â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â””â”€â”€ 0004_*.py         # ğŸ†• CRIADO (nÃ£o aplicado)
â”‚   â”‚
â”‚   â”œâ”€â”€ signals.py            # ğŸŸ¢ Auto-cria UserProfile
â”‚   â”œâ”€â”€ apps.py               # ğŸŸ¢ Importa signals
â”‚   â”œâ”€â”€ admin.py
â”‚   â”œâ”€â”€ forms.py
â”‚   â”œâ”€â”€ views.py
â”‚   â””â”€â”€ urls.py
â”‚
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ base.html
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ library.html      # Interface prateleiras
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ accounts/
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ static/
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â”œâ”€â”€ themes.css
â”‚   â”‚   â””â”€â”€ library-profile.css
â”‚   â””â”€â”€ js/
â”‚       â”œâ”€â”€ library-manager.js
â”‚       â””â”€â”€ theme-switcher.js
â”‚
â”œâ”€â”€ media/                    # BACKUP LOCAL (Supabase Ã© principal)
â””â”€â”€ documents/
    â””â”€â”€ status/
        â”œâ”€â”€ status_09102025.md
        â””â”€â”€ status_12102025.md  # Este arquivo
```

---

## ğŸ”‘ Comandos Ãšteis

### Ambiente Virtual
```powershell
# Ativar
.\.venv\Scripts\Activate.ps1

# Desativar
deactivate
```

### Django
```powershell
# Servidor
python manage.py runserver

# Migrations
python manage.py makemigrations
python manage.py migrate
python manage.py showmigrations accounts

# Shell
python manage.py shell

# Verificar problemas
python manage.py check
```

### Git
```powershell
git status
git log --oneline -5
git diff
git add .
git commit -m "mensagem"
git push origin main
```

### Supabase Storage
```powershell
# Listar arquivos
python manage.py shell
```
```python
from core.utils.supabase_storage import supabase_storage
files = supabase_storage.list_files('user-avatars')
for f in files:
    print(f['name'])
exit()
```

---

## ğŸš¨ PROBLEMAS CONHECIDOS E SOLUÃ‡Ã•ES

### **1. AttributeError: 'UserProfile' has no attribute 'custom_shelves_list'**

**Causa:** Migration nÃ£o foi aplicada

**SoluÃ§Ã£o:**
```powershell
python manage.py migrate accounts
```

---

### **2. Prateleira nÃ£o aparece apÃ³s criar**

**Causa:** JavaScript nÃ£o estÃ¡ recarregando pÃ¡gina

**Debug:**
1. F12 â†’ Console (ver erros)
2. F12 â†’ Network â†’ Response de `/api/library/create-custom-shelf/`
3. Verificar se `response.success === true`
4. Verificar se `location.reload()` estÃ¡ sendo executado

**SoluÃ§Ã£o temporÃ¡ria:**
- Recarregar pÃ¡gina manualmente (F5)

---

### **3. Server Error 500 ao acessar /biblioteca/**

**PossÃ­veis causas:**
- Migration nÃ£o aplicada
- Campo `custom_shelves_list` nÃ£o existe no banco
- Profile nÃ£o existe para o usuÃ¡rio

**Debug:**
```powershell
# Ver traceback completo no terminal do servidor
# Procurar por AttributeError
```

---

## ğŸ“Š Funcionalidades Implementadas

### âœ… Core (Livraria)
- PÃ¡gina inicial com seÃ§Ãµes dinÃ¢micas
- CatÃ¡logo com paginaÃ§Ã£o e filtros
- Book detail com avaliaÃ§Ãµes
- Sistema de busca
- Google Books API integrada
- Supabase Storage (146 arquivos)

### âœ… Sistema de Biblioteca Pessoal
- 4 Prateleiras padrÃ£o (Favoritos, Quero Ler, Lendo, Lidos)
- Prateleiras personalizadas
- Interface estilo Google Books
- AJAX para adicionar/remover livros
- Modal para criar prateleiras
- Dropdown com scroll

### âœ… Sistema de GamificaÃ§Ã£o
- XP por livro lido (10 XP)
- Sistema de nÃ­veis (1-30)
- Badges (estrutura pronta)
- Streak de leitura consecutiva
- Contador de livros lidos
- Contador de pÃ¡ginas lidas
- Meta anual de leitura

### âœ… Sistema de Temas
- 3 Temas FREE (Fantasy, Classic, Romance)
- 12 Temas PREMIUM
- PersistÃªncia no localStorage
- AdaptaÃ§Ã£o clara/escuro

### âœ… Admin Dashboard
- EstatÃ­sticas clicÃ¡veis
- GrÃ¡ficos Chart.js
- Google Books search integrada
- AÃ§Ãµes rÃ¡pidas

### ğŸš§ Em Desenvolvimento
- Prateleiras personalizadas com lista no profile
- Sistema de perfil (avatar, banner, bio)
- Upload para Supabase Storage

---

## ğŸ¯ PrÃ³ximas Funcionalidades Planejadas

### Prioridade ALTA
1. **Finalizar Sistema de Prateleiras** (em andamento)
2. **Sistema de Carrinho de Compras**
3. **Filtros AvanÃ§ados no CatÃ¡logo**

### Prioridade MÃ‰DIA
4. Sistema de Reviews PÃºblico
5. Progresso de Leitura Visual
6. GamificaÃ§Ã£o Completa (badges visuais)

### Prioridade BAIXA
7. Chatbot LiterÃ¡rio Funcional
8. Sistema de SincronizaÃ§Ã£o AutomÃ¡tica

---

## ğŸ” CONTEXTO PARA RETOMAR O TRABALHO

### **Para o prÃ³ximo assistente/desenvolvedor:**

**Estado atual:**
- âœ… CÃ³digo pronto em 3 arquivos (user_profile.py, library_ajax_views.py, library_view.py)
- âœ… Migration criada (0004_userprofile_custom_shelves_list.py)
- â³ **PENDENTE:** Aplicar migration (`migrate accounts`)
- â³ **PENDENTE:** Testar criaÃ§Ã£o de prateleira vazia
- â³ **PENDENTE:** Commit e push

**Como retomar:**

1. **Ler este documento completo** para entender contexto
2. **Verificar git status** (`git status`)
3. **Aplicar migration** (`python manage.py migrate accounts`)
4. **Testar** seguindo PASSO 2 e PASSO 3 acima
5. **Se tudo OK:** Fazer commit seguindo PASSO 5
6. **Se der erro:** Debug usando seÃ§Ã£o "PROBLEMAS CONHECIDOS"

**Arquivos importantes para anÃ¡lise:**
- `accounts/models/user_profile.py` - Ver campo e mÃ©todos adicionados
- `core/views/library_ajax_views.py` - Ver funÃ§Ã£o create_custom_shelf
- `core/views/library_view.py` - Ver lÃ³gica de prateleiras personalizadas
- `accounts/migrations/0004_*.py` - Ver migration gerada

**Comandos para verificar estado:**
```powershell
# Ver migrations pendentes
python manage.py showmigrations accounts

# Ver campos do UserProfile
python manage.py shell
```
```python
from accounts.models import UserProfile
print([f.name for f in UserProfile._meta.fields])
# Deve incluir: 'custom_shelves_list'
exit()
```

---

## ğŸ“ Links Importantes

### RepositÃ³rio
- **GitHub:** https://github.com/cgvargas/cgbookstore_v3
- **Branch:** main

### DocumentaÃ§Ã£o
- **Django:** https://docs.djangoproject.com/en/5.0/
- **Supabase:** https://supabase.com/docs
- **Bootstrap 5:** https://getbootstrap.com/docs/5.3/

### Supabase
- **Dashboard:** https://supabase.com/dashboard/project/uomjbcuowfgcwhsejatn
- **Storage:** https://supabase.com/dashboard/project/uomjbcuowfgcwhsejatn/storage/buckets

---

## ğŸ” Credenciais

### Admin Django
- **URL:** http://127.0.0.1:8000/admin/
- **User:** admin
- **Password:** Oa023568910@

### Biblioteca Pessoal
- **URL:** http://127.0.0.1:8000/biblioteca/
- **Requer:** Login de usuÃ¡rio autenticado

---

## ğŸ“ Resumo da SessÃ£o (12/10/2025 - 11:30)

### âœ… Completado:
1. Signal para auto-criaÃ§Ã£o de UserProfile
2. CorreÃ§Ã£o de SectionItemAdmin (duplicate key)
3. GamificaÃ§Ã£o em BookShelf (XP, contadores, streak)

### ğŸš§ Em Progresso:
4. Sistema de prateleiras personalizadas com lista no profile
   - CÃ³digo pronto
   - Migration criada
   - **Aguardando:** `migrate` + testes

### ğŸ“Š Commits Realizados: 5
- Signal UserProfile
- RemoÃ§Ã£o SectionItemAdmin
- CorreÃ§Ã£o gamificaÃ§Ã£o (add_points â†’ add_xp)
- CorreÃ§Ã£o campo (pages â†’ page_count)
- Fix migration content

### â³ PrÃ³ximo Commit Pendente:
- "Feat: Prateleiras personalizadas aparecem mesmo vazias"

---

**Ãšltima atualizaÃ§Ã£o:** 12/10/2025 - 11:30  
**Desenvolvedor:** Claude + cgvargas  
**Status:** ğŸŸ¡ ImplementaÃ§Ã£o completa, aguardando testes e commit final