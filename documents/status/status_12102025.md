# CGBookStore v3 - Documento de Estado do Projeto

**Data:** 12/10/2025 - 11:30  
**Versão:** 8.0  
**Última Atualização:** Sistema de Prateleiras Personalizadas com Lista no Profile

---

## 🎯 Visão Geral do Projeto

**CGBookStore v3** é uma livraria online desenvolvida em Django 5.0.3 com PostgreSQL (Supabase), focada em proporcionar uma experiência completa de leitura com biblioteca pessoal gamificada, sistema de prateleiras personalizadas, integração com Google Books API, Supabase Storage e dashboard administrativa moderna.

### Tecnologias Principais
- **Backend:** Django 5.0.3
- **Banco de Dados:** PostgreSQL 17.6 (Supabase) - Transaction Mode (porta 6543)
- **Storage:** Supabase Storage (3 buckets públicos: book-covers, author-photos, user-avatars)
- **Python:** 3.13
- **Frontend:** Bootstrap 5, Font Awesome, Swiper.js
- **APIs:** Google Books API - INTEGRADO
- **Controle de Versão:** Git + GitHub

---

## 📍 ESTADO ATUAL - Em Desenvolvimento

### 🚧 Branch: `main`
**Status:** Up to date with `origin/main`

### 📝 Arquivos Modificados (Não Staged):
```
modified:   accounts/models/user_profile.py
modified:   core/views/library_ajax_views.py
modified:   core/views/library_view.py
```

### 📄 Arquivos Novos (Untracked):
```
accounts/migrations/0004_userprofile_custom_shelves_list.py
```

### ⚠️ IMPORTANTE: Mudanças Pendentes de Commit
**NÃO fazer push antes de testar tudo!**

---

## 🔥 O QUE FOI IMPLEMENTADO HOJE (12/10/2025)

### **1. Signal para Auto-Criação de UserProfile** ✅ COMPLETO
- **Criado:** `accounts/signals.py`
- **Modificado:** `accounts/apps.py`
- **Funcionalidade:** UserProfile é criado automaticamente quando um User é registrado
- **Testado:** ✅ Funcionando
- **Committado:** ✅ Sim

### **2. Correção de Admin - Remoção de SectionItemAdmin** ✅ COMPLETO
- **Modificados:** `core/admin/__init__.py`, `core/admin/section_admin.py`
- **Problema Resolvido:** Duplicate key error em SectionItem
- **Solução:** Removido admin separado, mantido apenas inline
- **Testado:** ✅ Funcionando
- **Committado:** ✅ Sim

### **3. Sistema de Gamificação em BookShelf** ✅ COMPLETO
- **Modificado:** `accounts/models/book_shelf.py`
- **Correções:**
  - `add_points()` → `add_xp()` (método correto)
  - `book.pages` → `book.page_count` (campo correto)
- **Funcionalidade:** 
  - 10 XP por livro lido
  - Incrementa `books_read_count`
  - Incrementa `total_pages_read`
  - Atualiza `streak_days`
- **Testado:** ✅ Funcionando (livro adicionado, XP creditado)
- **Committado:** ✅ Sim

### **4. Sistema de Prateleiras Personalizadas com Lista** 🚧 EM IMPLEMENTAÇÃO
**Problema identificado:**
- Prateleiras personalizadas só apareciam APÓS adicionar um livro
- UX ruim: usuário cria prateleira, não vê na sidebar, fica confuso

**Solução implementada:**
- Campo `custom_shelves_list` (JSONField) no UserProfile
- Armazena lista de nomes: `['Meus Clássicos', 'Ficção Favorita']`
- View pega lista do profile e faz left join com BookShelf
- Prateleiras vazias aparecem com count=0

**Arquivos modificados:**

#### **A) `accounts/models/user_profile.py`** 🟡 MODIFICADO (não staged)
**Adicionado:**
- Campo `custom_shelves_list = JSONField(default=list)` (após linha ~117, depois de `badges`)
- Método `add_custom_shelf(shelf_name)` - Adiciona prateleira à lista
- Método `remove_custom_shelf(shelf_name)` - Remove prateleira
- Método `has_custom_shelf(shelf_name)` - Verifica existência
- Método `get_custom_shelves()` - Retorna lista ordenada

#### **B) `accounts/migrations/0004_userprofile_custom_shelves_list.py`** 🆕 CRIADO (não staged)
**Migration gerada:**
```python
operations = [
    migrations.AddField(
        model_name='userprofile',
        name='custom_shelves_list',
        field=models.JSONField(blank=True, default=list, ...),
    ),
]
```

**Status da Migration:**
- ✅ Arquivo gerado (`makemigrations` executado)
- ⏳ **PENDENTE:** Rodar `migrate` para aplicar no banco
- ⚠️ **NÃO APLICADA AINDA**

#### **C) `core/views/library_ajax_views.py`** 🟡 MODIFICADO (não staged)
**Função atualizada:** `create_custom_shelf()` (linha ~235)

**Mudanças:**
```python
# ANTES:
# Validava apenas, não salvava em lugar nenhum

# DEPOIS:
profile = request.user.profile
if profile.has_custom_shelf(custom_shelf_name):
    return erro
profile.add_custom_shelf(custom_shelf_name)  # ← SALVA NA LISTA
```

#### **D) `core/views/library_view.py`** 🟡 MODIFICADO (não staged)
**Seção atualizada:** Prateleiras Personalizadas (linhas ~65-85)

**Mudanças:**
```python
# ANTES:
custom_shelves_data = BookShelf.objects.filter(
    user=user, shelf_type='custom'
).values('custom_shelf_name').annotate(count=Count('id'))
# ↑ Só retornava prateleiras COM livros

# DEPOIS:
if profile:
    shelf_names = profile.get_custom_shelves()  # ← Pega TODAS
    for shelf_name in shelf_names:
        books = BookShelf.objects.filter(...)  # Left join
        custom_shelves_list.append({
            'name': shelf_name,
            'count': books.count(),  # ← Pode ser 0
            'books': books
        })
```

---

## 🧪 STATUS DE TESTES

### ✅ Testado e Funcionando:
- [x] Signal cria UserProfile automaticamente
- [x] Adicionar livro à biblioteca (prateleiras padrão)
- [x] Gamificação: XP, books_read_count, total_pages_read, streak
- [x] Admin sem erro de duplicate key

### ⏳ Aguardando Teste (Implementação Completa):
- [ ] **Migration aplicada** (`migrate accounts`)
- [ ] Criar prateleira personalizada via `/biblioteca/`
- [ ] Prateleira vazia aparece na sidebar
- [ ] Adicionar livro à prateleira personalizada
- [ ] Count atualiza corretamente
- [ ] Persistência entre devices

---

## 🎯 PRÓXIMOS PASSOS - CHECKLIST DE IMPLEMENTAÇÃO

### **PASSO 1: Aplicar Migration** ⚠️ CRÍTICO
```powershell
cd C:\ProjectDjango\cgbookstore_v3
.\.venv\Scripts\Activate.ps1

# Aplicar migration
python manage.py migrate accounts

# Esperado:
# Applying accounts.0004_userprofile_custom_shelves_list... OK
```

**Por que é crítico?**
- UserProfile no banco NÃO tem o campo `custom_shelves_list` ainda
- Views tentam usar `profile.get_custom_shelves()` → AttributeError
- Servidor pode quebrar ao acessar `/biblioteca/`

---

### **PASSO 2: Testar Criação de Prateleira**

```powershell
# Iniciar servidor
python manage.py runserver
```

**No navegador:**
1. Acessar: `http://127.0.0.1:8000/biblioteca/`
2. Clicar "Nova Prateleira" (botão na sidebar)
3. Nome: "Meus Clássicos"
4. Clicar "Criar Prateleira"
5. **✅ Esperado:** Prateleira aparece IMEDIATAMENTE na sidebar (count: 0)

**Se der erro:**
- Ver console do servidor (traceback)
- Ver DevTools F12 → Console (erros JS)
- Ver DevTools → Network → Response da requisição

---

### **PASSO 3: Testar Adicionar Livro**

1. Ir em qualquer livro: `http://127.0.0.1:8000/livros/o-problema-dos-tres-corpos/`
2. "Adicionar à Biblioteca" → Selecionar "Meus Clássicos"
3. Voltar em `/biblioteca/`
4. **✅ Esperado:** Prateleira mostra count=1, livro aparece

---

### **PASSO 4: Verificar Persistência (Shell)**

```powershell
python manage.py shell
```

```python
from django.contrib.auth.models import User

# Pegar admin
user = User.objects.get(username='admin')
profile = user.profile

# Ver prateleiras
print(f"Prateleiras: {profile.custom_shelves_list}")
# Esperado: ['Meus Clássicos']

# Testar métodos
print(f"Tem 'Meus Clássicos'? {profile.has_custom_shelf('Meus Clássicos')}")
# Esperado: True

# Ver todas ordenadas
print(f"Todas: {profile.get_custom_shelves()}")
# Esperado: ['Meus Clássicos']

exit()
```

---

### **PASSO 5: Commit e Push**

**Se TODOS os testes passarem:**

```powershell
git status

git add accounts/models/user_profile.py
git add accounts/migrations/0004_userprofile_custom_shelves_list.py
git add core/views/library_ajax_views.py
git add core/views/library_view.py

git commit -m "Feat: Prateleiras personalizadas aparecem mesmo vazias

Problema:
- Prateleiras só apareciam após adicionar livro
- Usuário confuso (criou mas não vê)
- UX ruim

Solução:
- Campo custom_shelves_list (JSONField) no UserProfile
- Armazena lista de nomes de prateleiras
- View pega lista e faz left join com BookShelf
- Prateleiras vazias aparecem com count=0

Migration:
- 0004_userprofile_custom_shelves_list

Métodos UserProfile:
- add_custom_shelf(name) - Adiciona à lista
- remove_custom_shelf(name) - Remove da lista
- has_custom_shelf(name) - Verifica existência
- get_custom_shelves() - Retorna lista ordenada

Views Atualizadas:
- library_ajax_views.create_custom_shelf() - Salva no profile
- library_view.LibraryView - Mostra todas (vazias ou não)

Testes:
- Criar prateleira → aparece imediatamente ✅
- Adicionar livro → contador atualiza ✅
- Persistência entre devices ✅
- Shell confirma dados no profile ✅"

git push origin main
```

---

## 📂 Estrutura Atual do Projeto

```
C:\ProjectDjango\cgbookstore_v3\
├── cgbookstore/              # Configurações do projeto
│   ├── settings.py           # Supabase Transaction Mode + Storage
│   ├── urls.py
│   └── wsgi.py
│
├── core/                     # App principal (livraria)
│   ├── models/               # MODULAR
│   │   ├── __init__.py
│   │   ├── category.py
│   │   ├── author.py
│   │   ├── book.py          # Campo: page_count
│   │   ├── video.py
│   │   ├── section.py
│   │   ├── section_item.py
│   │   └── event.py
│   │
│   ├── admin/                # ADMIN MODULAR
│   │   ├── __init__.py      # 🟢 SectionItemAdmin removido
│   │   ├── section_admin.py # 🟢 Classe SectionItemAdmin deletada
│   │   └── ...
│   │
│   ├── views/                # MODULAR
│   │   ├── library_view.py           # 🟡 MODIFICADO (prateleiras vazias)
│   │   ├── library_ajax_views.py     # 🟡 MODIFICADO (salva no profile)
│   │   └── ...
│   │
│   ├── storage_backends.py   # Supabase Storage
│   └── urls.py
│
├── accounts/                 # App de autenticação
│   ├── models/               # MODULAR
│   │   ├── __init__.py
│   │   ├── user_profile.py   # 🟡 MODIFICADO (campo + métodos)
│   │   ├── book_shelf.py     # 🟢 Gamificação funcionando
│   │   ├── reading_progress.py
│   │   └── book_review.py
│   │
│   ├── migrations/
│   │   └── 0004_*.py         # 🆕 CRIADO (não aplicado)
│   │
│   ├── signals.py            # 🟢 Auto-cria UserProfile
│   ├── apps.py               # 🟢 Importa signals
│   ├── admin.py
│   ├── forms.py
│   ├── views.py
│   └── urls.py
│
├── templates/
│   ├── base.html
│   ├── core/
│   │   ├── library.html      # Interface prateleiras
│   │   └── ...
│   └── accounts/
│       └── ...
│
├── static/
│   ├── css/
│   │   ├── themes.css
│   │   └── library-profile.css
│   └── js/
│       ├── library-manager.js
│       └── theme-switcher.js
│
├── media/                    # BACKUP LOCAL (Supabase é principal)
└── documents/
    └── status/
        ├── status_09102025.md
        └── status_12102025.md  # Este arquivo
```

---

## 🔑 Comandos Úteis

### Ambiente Virtual
```powershell
# Ativar
.\.venv\Scripts\Activate.ps1

# Desativar
deactivate
```

### Django
```powershell
# Servidor
python manage.py runserver

# Migrations
python manage.py makemigrations
python manage.py migrate
python manage.py showmigrations accounts

# Shell
python manage.py shell

# Verificar problemas
python manage.py check
```

### Git
```powershell
git status
git log --oneline -5
git diff
git add .
git commit -m "mensagem"
git push origin main
```

### Supabase Storage
```powershell
# Listar arquivos
python manage.py shell
```
```python
from core.utils.supabase_storage import supabase_storage
files = supabase_storage.list_files('user-avatars')
for f in files:
    print(f['name'])
exit()
```

---

## 🚨 PROBLEMAS CONHECIDOS E SOLUÇÕES

### **1. AttributeError: 'UserProfile' has no attribute 'custom_shelves_list'**

**Causa:** Migration não foi aplicada

**Solução:**
```powershell
python manage.py migrate accounts
```

---

### **2. Prateleira não aparece após criar**

**Causa:** JavaScript não está recarregando página

**Debug:**
1. F12 → Console (ver erros)
2. F12 → Network → Response de `/api/library/create-custom-shelf/`
3. Verificar se `response.success === true`
4. Verificar se `location.reload()` está sendo executado

**Solução temporária:**
- Recarregar página manualmente (F5)

---

### **3. Server Error 500 ao acessar /biblioteca/**

**Possíveis causas:**
- Migration não aplicada
- Campo `custom_shelves_list` não existe no banco
- Profile não existe para o usuário

**Debug:**
```powershell
# Ver traceback completo no terminal do servidor
# Procurar por AttributeError
```

---

## 📊 Funcionalidades Implementadas

### ✅ Core (Livraria)
- Página inicial com seções dinâmicas
- Catálogo com paginação e filtros
- Book detail com avaliações
- Sistema de busca
- Google Books API integrada
- Supabase Storage (146 arquivos)

### ✅ Sistema de Biblioteca Pessoal
- 4 Prateleiras padrão (Favoritos, Quero Ler, Lendo, Lidos)
- Prateleiras personalizadas
- Interface estilo Google Books
- AJAX para adicionar/remover livros
- Modal para criar prateleiras
- Dropdown com scroll

### ✅ Sistema de Gamificação
- XP por livro lido (10 XP)
- Sistema de níveis (1-30)
- Badges (estrutura pronta)
- Streak de leitura consecutiva
- Contador de livros lidos
- Contador de páginas lidas
- Meta anual de leitura

### ✅ Sistema de Temas
- 3 Temas FREE (Fantasy, Classic, Romance)
- 12 Temas PREMIUM
- Persistência no localStorage
- Adaptação clara/escuro

### ✅ Admin Dashboard
- Estatísticas clicáveis
- Gráficos Chart.js
- Google Books search integrada
- Ações rápidas

### 🚧 Em Desenvolvimento
- Prateleiras personalizadas com lista no profile
- Sistema de perfil (avatar, banner, bio)
- Upload para Supabase Storage

---

## 🎯 Próximas Funcionalidades Planejadas

### Prioridade ALTA
1. **Finalizar Sistema de Prateleiras** (em andamento)
2. **Sistema de Carrinho de Compras**
3. **Filtros Avançados no Catálogo**

### Prioridade MÉDIA
4. Sistema de Reviews Público
5. Progresso de Leitura Visual
6. Gamificação Completa (badges visuais)

### Prioridade BAIXA
7. Chatbot Literário Funcional
8. Sistema de Sincronização Automática

---

## 🔍 CONTEXTO PARA RETOMAR O TRABALHO

### **Para o próximo assistente/desenvolvedor:**

**Estado atual:**
- ✅ Código pronto em 3 arquivos (user_profile.py, library_ajax_views.py, library_view.py)
- ✅ Migration criada (0004_userprofile_custom_shelves_list.py)
- ⏳ **PENDENTE:** Aplicar migration (`migrate accounts`)
- ⏳ **PENDENTE:** Testar criação de prateleira vazia
- ⏳ **PENDENTE:** Commit e push

**Como retomar:**

1. **Ler este documento completo** para entender contexto
2. **Verificar git status** (`git status`)
3. **Aplicar migration** (`python manage.py migrate accounts`)
4. **Testar** seguindo PASSO 2 e PASSO 3 acima
5. **Se tudo OK:** Fazer commit seguindo PASSO 5
6. **Se der erro:** Debug usando seção "PROBLEMAS CONHECIDOS"

**Arquivos importantes para análise:**
- `accounts/models/user_profile.py` - Ver campo e métodos adicionados
- `core/views/library_ajax_views.py` - Ver função create_custom_shelf
- `core/views/library_view.py` - Ver lógica de prateleiras personalizadas
- `accounts/migrations/0004_*.py` - Ver migration gerada

**Comandos para verificar estado:**
```powershell
# Ver migrations pendentes
python manage.py showmigrations accounts

# Ver campos do UserProfile
python manage.py shell
```
```python
from accounts.models import UserProfile
print([f.name for f in UserProfile._meta.fields])
# Deve incluir: 'custom_shelves_list'
exit()
```

---

## 📞 Links Importantes

### Repositório
- **GitHub:** https://github.com/cgvargas/cgbookstore_v3
- **Branch:** main

### Documentação
- **Django:** https://docs.djangoproject.com/en/5.0/
- **Supabase:** https://supabase.com/docs
- **Bootstrap 5:** https://getbootstrap.com/docs/5.3/

### Supabase
- **Dashboard:** https://supabase.com/dashboard/project/uomjbcuowfgcwhsejatn
- **Storage:** https://supabase.com/dashboard/project/uomjbcuowfgcwhsejatn/storage/buckets

---

## 🔐 Credenciais

### Admin Django
- **URL:** http://127.0.0.1:8000/admin/
- **User:** admin
- **Password:** Oa023568910@

### Biblioteca Pessoal
- **URL:** http://127.0.0.1:8000/biblioteca/
- **Requer:** Login de usuário autenticado

---

## 📝 Resumo da Sessão (12/10/2025 - 11:30)

### ✅ Completado:
1. Signal para auto-criação de UserProfile
2. Correção de SectionItemAdmin (duplicate key)
3. Gamificação em BookShelf (XP, contadores, streak)

### 🚧 Em Progresso:
4. Sistema de prateleiras personalizadas com lista no profile
   - Código pronto
   - Migration criada
   - **Aguardando:** `migrate` + testes

### 📊 Commits Realizados: 5
- Signal UserProfile
- Remoção SectionItemAdmin
- Correção gamificação (add_points → add_xp)
- Correção campo (pages → page_count)
- Fix migration content

### ⏳ Próximo Commit Pendente:
- "Feat: Prateleiras personalizadas aparecem mesmo vazias"

---

**Última atualização:** 12/10/2025 - 11:30  
**Desenvolvedor:** Claude + cgvargas  
**Status:** 🟡 Implementação completa, aguardando testes e commit final