# CGBookStore v3 - Documento de Estado do Projeto

**Data:** 05/10/2025 - 20:30  
**Versão:** 6.1  
**Última Atualização:** Correções e Melhorias na Biblioteca Pessoal

---

## Visão Geral do Projeto

**CGBookStore v3** é uma livraria online desenvolvida em Django 5.0.3 com PostgreSQL (Supabase), focada em proporcionar uma experiência completa de leitura com biblioteca pessoal gamificada, sistema de eventos literários, integração com Google Books API e dashboard administrativa moderna.

### Tecnologias Principais
- **Backend:** Django 5.0.3
- **Banco de Dados:** PostgreSQL 17.6 (Supabase) - Transaction Mode (porta 6543)
- **Python:** 3.13
- **Frontend:** Bootstrap 5, Font Awesome, Swiper.js
- **APIs:** Google Books API - INTEGRADO
- **Controle de Versão:** Git + GitHub

---

## Estrutura Atual do Projeto

```
C:\ProjectDjango\cgbookstore_v3\
├── cgbookstore/              # Configurações do projeto
│   ├── settings.py           # Supabase Transaction Mode + Google Books API
│   ├── urls.py               # Static/Media configurado
│   └── wsgi.py
│
├── core/                     # App principal (livraria)
│   ├── models/               # MODULAR
│   │   ├── __init__.py
│   │   ├── category.py
│   │   ├── author.py         # COM FOTO + REDES SOCIAIS
│   │   ├── book.py
│   │   ├── video.py          # YouTube Shorts support
│   │   ├── section.py
│   │   ├── section_item.py
│   │   └── event.py
│   │
│   ├── admin/                # ADMIN MODULAR
│   │   ├── __init__.py
│   │   ├── author_admin.py
│   │   ├── book_admin.py
│   │   ├── category_admin.py
│   │   ├── event_admin.py
│   │   ├── section_admin.py
│   │   ├── video_admin.py
│   │   └── widgets.py
│   │
│   ├── views/                # MODULAR
│   │   ├── __init__.py
│   │   ├── about_view.py
│   │   ├── book_detail_view.py
│   │   ├── book_views.py   
│   │   ├── contact_view.py      
│   │   ├── dashboard_view.py 
│   │   ├── event_views.py
│   │   ├── google_books_views.py
│   │   ├── home_view.py
│   │   ├── library_view.py       
│   │   ├── library_ajax_views.py 
│   │   └── search_view.py
│   │
│   ├── management/
│   │   └── commands/
│   │       ├── add_book_covers.py
│   │       ├── populate_db.py
│   │       ├── setup_supabase.py
│   │       ├── test_google_books.py
│   │       └── update_covers_google.py
│   │
│   ├── utils/
│   │   ├── google_books_api.py
│   │   └── supabase_storage.py
│   │
│   └── urls.py                
│
├── accounts/                 # App de autenticação
│   ├── models/               # MODULAR - Sistema de Biblioteca
│   │   ├── user_profile.py
│   │   ├── book_shelf.py     # Prateleiras de livros
│   │   ├── reading_progress.py
│   │   └── book_review.py
│   ├── admin.py
│   ├── forms.py
│   ├── views.py
│   └── urls.py
│
├── templates/
│   ├── base.html             # Theme switcher integrado
│   ├── admin/
│   │   ├── base_site.html
│   │   ├── dashboard.html
│   │   └── core/book/google_books_search.html
│   ├── chatbot_literario/
│   │   └── chat.html
│   ├── core/
│   │   ├── about.html
│   │   ├── home.html
│   │   ├── book_list.html
│   │   ├── book_detail.html  # Dropdown + Modal + Prateleiras Personalizadas
│   │   ├── library.html      # Interface estilo Google Books
│   │   ├── events.html
│   │   ├── search_results.html
│   │   └── widgets/event_widget.html
│   └── accounts/
│       ├── login.html
│       └── register.html
│
├── static/
│   ├── css/
│   │   ├── themes.css        # Variáveis sidebar + temas + dropdown scroll
│   │   ├── catalog-filters.css
│   │   ├── section_inline.css
│   │   ├── section_item_search.css
│   │   └── themes.css
│   │ 
│   └── js/
│       ├── admin-charts.js
│       ├── catalog-filters.js
│       ├── library-manager.js    
│       ├── section_inline.js
│       ├── section_item_search.js
│       └── theme-switcher.js
│
├── media/                    # Configurado e funcionando
│   ├── books/covers/         # 39 capas Google Books
│   ├── authors/photos/
│   └── events/
│
└── documents/status/
    └── status_05102025.md    # Este arquivo
```

---

## Funcionalidades Implementadas

### Core (Livraria)
- Página inicial com seções dinâmicas gerenciáveis
- 5 seções criadas: Lançamentos 2025, Fantasia, Clássicos, Mais Vendidos, Autores
- Widget de evento na home
- Página de eventos (`/eventos/`)
- Catálogo de livros com paginação (12 por página)
- BookDetailView completa
- Sistema de avaliação com 5 estrelas
- Sistema de busca (título, autor, categoria)
- Páginas "Sobre" e "Contato"
- Upload de imagens funcionando
- Navegação com breadcrumbs
- Livros relacionados por categoria

### Sistema de Biblioteca Pessoal (COMPLETO - 05/10/2025)

#### FASE 1 - Backend AJAX (Concluída)
**Arquivo:** `core/views/library_ajax_views.py`
- `add_to_shelf()` - Adicionar livro a prateleira
- `remove_from_shelf()` - Remover livro
- `get_book_shelves()` - Listar prateleiras de um livro
- `create_custom_shelf()` - Validar prateleira personalizada
- `move_to_shelf()` - Mover livro entre prateleiras

**Rotas AJAX criadas:**
```
/api/library/add-to-shelf/
/api/library/remove-from-shelf/
/api/library/get-book-shelves/<id>/
/api/library/create-custom-shelf/
/api/library/move-to-shelf/
```

#### FASE 2 - Frontend JavaScript (Concluída)
**Arquivo:** `static/js/library-manager.js`
- Módulo JavaScript completo (500+ linhas)
- Sistema de toasts personalizados (sem fundo, bordas coloridas)
- Loading states em botões
- Atualização dinâmica de contadores
- Event delegation para elementos dinâmicos
- Função `getCookie()` para CSRF token
- Animações CSS (slide-in/out, fade)
- **Remoção visual de livros com fade-out**
- **Detecção automática de prateleira vazia**

#### FASE 3 - Book Detail (Concluída)
**Arquivo:** `templates/core/book_detail.html`
- Botão "Adicionar à Biblioteca" ativado
- Dropdown com 4 prateleiras padrão
- **Prateleiras personalizadas listadas dinamicamente**
- Ícones coloridos (❤️ Favoritos, 📖 Quero Ler, 📗 Lendo, ✅ Lidos)
- Indicador visual de prateleiras atuais
- Loading states e feedback
- Auto-carrega estado ao abrir página
- **Scroll automático no dropdown (max-height: 450px)**

#### FASE 4 - Prateleiras Personalizadas (Concluída)
**Funcionalidades:**
- Modal Bootstrap para criar prateleira personalizada
- Validação de nome (não vazio, máx 100 caracteres)
- Opção "Nova Prateleira Personalizada" no dropdown
- Botão "Nova Prateleira" na biblioteca
- Sistema de validação de duplicatas
- Feedback visual com toasts
- Enter para submeter formulário
- Prateleiras aparecem na sidebar automaticamente
- **Integração completa com dropdown do book_detail**

#### FASE 5 - Melhorias e Correções (Concluída - 05/10/2025)
**Correções implementadas:**
1. **Dropdown com Scroll:**
   - CSS `dropdown-menu-scrollable` com max-height 450px
   - Scrollbar customizada (8px, cores adaptadas aos temas)
   - Headers sticky ao scrollar
   - Scroll aparece automaticamente com 3+ prateleiras personalizadas

2. **Remoção Visual de Livros:**
   - Card desaparece com animação fade-out (0.3s)
   - Remove do DOM após animação
   - Detecta prateleira vazia automaticamente
   - Mostra mensagem "empty-shelf" com ícone adequado
   - Botão "Explorar Livros" quando vazia

3. **Toast Personalizado:**
   - Fundo transparente (sem cor de fundo)
   - Bordas coloridas (2px solid)
   - Texto e ícone coloridos
   - Mantém cores por tipo (verde=sucesso, vermelho=erro, amarelo=aviso, azul=info)
   - Font-weight 500 para melhor legibilidade

4. **Bug Fix - custom_shelf_name:**
   - Corrigida função wrapper `addToShelf()` no template
   - Agora aceita 3 parâmetros: `(bookId, shelfType, customShelfName = '')`
   - Passa corretamente o nome da prateleira personalizada ao LibraryManager
   - Validação backend funcionando 100%

### Interface da Biblioteca (`/biblioteca/`)
**Layout estilo Google Books:**
- Barra lateral fixa com navegação
- Grid de livros com capas (240px altura)
- 4 prateleiras padrão + personalizadas
- Cards estatísticos (Pontos, Livros/ano, Nível)
- Contadores em tempo real
- Botão remover ao hover
- **Remoção visual com feedback**
- Temas claro/escuro integrados
- Responsivo (mobile friendly)

**Variáveis CSS adicionadas:**
```css
--sidebar-bg: #f8f9fa (claro) / #1a1d20 (escuro)
--sidebar-stats-bg: #e9ecef (claro) / #232628 (escuro)

/* Dropdown scrollable */
.dropdown-menu-scrollable {
    max-height: 450px;
    overflow-y: auto;
}
```

### Sistema de Temas
- 3 Temas: Claro, Escuro, Sistema (auto)
- Variáveis CSS organizadas
- Persistência no localStorage
- Detecção automática do SO
- Transições suaves
- Switcher visual no navbar
- Contraste otimizado
- Dropdown scrollbar adaptado aos temas

### Dashboard Admin Personalizada
- Tema escuro completo
- 6 Cards de estatísticas clicáveis
- Botão "Voltar ao Site"
- Seção de Ações Rápidas
- Últimos Livros + Próximos Eventos
- 3 Gráficos Chart.js interativos

### Google Books API Integration
- Módulo `google_books_api.py` com 10 funções
- Busca por título, autor, ISBN, editora
- Download automático de capas
- 39/47 capas reais baixadas (83%)
- Interface Admin com paginação
- Importação com um clique
- Criação automática de autores/categorias

### Autenticação
- Registro de usuários
- Login/Logout
- Proteção de rotas
- Navbar dinâmica
- Link Admin para staff/superuser

---

## URLs Mapeadas

| URL | View | Nome | Autenticação |
|-----|------|------|--------------|
| `/` | HomeView | `core:home` | Não |
| `/livros/` | BookListView | `core:book_list` | Não |
| `/livros/<slug>/` | BookDetailView | `core:book_detail` | Não |
| `/biblioteca/` | LibraryView | `core:library` | **Sim** |
| `/eventos/` | EventListView | `core:events` | Não |
| `/admin/` | admin_dashboard | `admin:index` | Sim (staff) |
| `/admin/google-books/search/` | google_books_search | `admin:google_books_search` | Sim (staff) |
| `/api/library/add-to-shelf/` | add_to_shelf | `core:add_to_shelf` | Sim |
| `/api/library/remove-from-shelf/` | remove_from_shelf | `core:remove_from_shelf` | Sim |
| `/api/library/get-book-shelves/<id>/` | get_book_shelves | `core:get_book_shelves` | Sim |
| `/api/library/create-custom-shelf/` | create_custom_shelf | `core:create_custom_shelf` | Sim |
| `/api/library/move-to-shelf/` | move_to_shelf | `core:move_to_shelf` | Sim |

---

## Configurações Importantes

### Banco de Dados (settings.py)
```python
import dj_database_url
from decouple import config

DATABASES = {
    'default': dj_database_url.config(
        default=config('DATABASE_URL'),
        conn_max_age=60,
        conn_health_checks=True,
    )
}
```

### Variáveis de Ambiente (.env)
```env
SECRET_KEY=Oa023568910@
DEBUG=True
ALLOWED_HOSTS=localhost,127.0.0.1

# Supabase PostgreSQL - TRANSACTION MODE (porta 6543)
DATABASE_URL=postgresql://postgres.uomjbcuowfgcwhsejatn:Oa023568910@@aws-1-sa-east-1.pooler.supabase.com:6543/postgres

# Google Books API
GOOGLE_BOOKS_API_KEY=AIzaSyBF5W5NktgXZRfTnZXe3pVxqB_TCkXGzx0
```

**IMPORTANTE:** Sempre usar porta **6543** (Transaction Mode) para evitar limite de conexões.

---

## Próximas Funcionalidades Planejadas

### Prioridade ALTA

**1. Sistema de Carrinho de Compras**
   - Models: Cart, CartItem, Order
   - Adicionar/remover itens
   - Checkout básico
   - Histórico de pedidos

**2. Filtros Avançados no Catálogo**
   - Filtro por categoria
   - Filtro por faixa de preço
   - Ordenação (preço, data, título, avaliação)
   - Busca avançada

### Prioridade MÉDIA

**3. Sistema de Reviews Público**
   - Comentários públicos nos livros
   - Sistema de likes/dislikes
   - Moderação

**4. Progresso de Leitura**
   - Barra de progresso visual
   - Páginas lidas / Total
   - Estimativa de término
   - Estatísticas de leitura

**5. Gamificação Completa**
   - Badges/Conquistas visuais
   - Sistema de níveis expandido
   - Desafios de leitura
   - Ranking de leitores

### Prioridade BAIXA

**6. Chatbot Literário Funcional**
   - Integração com API (OpenAI/Ollama)
   - Recomendações personalizadas
   - Conversação sobre livros

**7. Sistema de Sincronização Automática**
   - Command para atualizar metadados
   - Verificar livros novos no Google Books
   - Atualizar ratings e reviews
   - Schedule com Celery

---

## Comandos Úteis

### Ambiente Virtual
```powershell
# Ativar
.\.venv\Scripts\activate

# Desativar
deactivate
```

### Django
```powershell
# Rodar servidor
python manage.py runserver

# Migrations
python manage.py makemigrations
python manage.py migrate

# Criar superuser
python manage.py createsuperuser

# Shell interativo
python manage.py shell

# Verificar problemas
python manage.py check

# Popular banco
python manage.py populate_db --verbose

# Atualizar capas Google Books
python manage.py update_covers_google --force --delay 0.5

# Testar Google Books API
python manage.py test_google_books --title "Harry Potter" --max-results 3
```

### Git
```powershell
git status
git add .
git commit -m "Feat: Descrição"
git push
```

---

## Últimos Commits Importantes (05/10/2025)

```bash
# Sessão Anterior
✅ Feat: Sistema completo de Biblioteca Pessoal (FASES 1-4)
✅ Feat: 5 APIs AJAX para gerenciamento de prateleiras
✅ Feat: LibraryManager.js - Módulo JavaScript completo
✅ Feat: Interface estilo Google Books para biblioteca
✅ Feat: Prateleiras personalizadas funcionais
✅ Feat: Modal de criação de prateleiras
✅ Feat: Dropdown de prateleiras no book_detail
✅ Feat: Sistema de toasts para feedback visual
✅ Fix: Variáveis CSS para sidebar (temas claro/escuro)
✅ Style: Capas com 240px mantendo proporção
✅ Style: Layout responsivo da biblioteca

# Sessão Atual (05/10/2025)
✅ Feat: Dropdown com scroll automático (max-height 450px)
✅ Feat: Prateleiras personalizadas listadas no dropdown
✅ Feat: Remoção visual de livros com fade-out
✅ Feat: Detecção automática de prateleira vazia
✅ Style: Toast personalizado (sem fundo, bordas coloridas)
✅ Fix: Função addToShelf aceita custom_shelf_name corretamente
✅ Fix: Scrollbar customizada para dropdown
✅ Fix: Headers sticky no dropdown scrollable
```

---

## Links Importantes

### Repositório
- **GitHub:** https://github.com/cgvargas/cgbookstore_v3
- **Branch Principal:** main

### Documentação
- **Django Docs:** https://docs.djangoproject.com/en/5.0/
- **Bootstrap 5:** https://getbootstrap.com/docs/5.3/
- **Supabase Docs:** https://supabase.com/docs
- **Google Books API:** https://developers.google.com/books

### Supabase
- **Dashboard:** https://supabase.com/dashboard
- **Project:** uomjbcuowfgcwhsejatn

---

## Credenciais de Acesso

### Admin Django
- **URL:** http://127.0.0.1:8000/admin/
- **User:** admin
- **Password:** Oa023568910@

### Dashboard
- **URL:** http://127.0.0.1:8000/admin/
- **Requer:** Login como staff/superuser

### Biblioteca Pessoal
- **URL:** http://127.0.0.1:8000/biblioteca/
- **Requer:** Login de usuário autenticado

---

## Resumo da Sessão (05/10/2025 - 20:30)

### Implementado:
1. **Dropdown com Prateleiras Personalizadas:**
   - Backend: BookDetailView passa `custom_shelves` no contexto
   - Template: Loop Django renderiza prateleiras dinamicamente
   - Scroll automático após 3+ prateleiras

2. **CSS Dropdown Scrollable:**
   - Max-height: 450px
   - Scrollbar customizada (8px)
   - Headers sticky
   - Cores adaptadas aos temas

3. **Remoção Visual de Livros:**
   - Animação fade-out (0.3s)
   - Remove card do DOM
   - Detecta prateleira vazia
   - Mostra mensagem "empty-shelf"

4. **Toast Personalizado:**
   - Background transparente
   - Bordas coloridas (2px)
   - Texto e ícone coloridos
   - Mantém semântica (verde=sucesso, etc)

5. **Bug Fix Crítico:**
   - Função `addToShelf()` no template corrigida
   - Aceita 3 parâmetros incluindo `customShelfName`
   - Passa corretamente ao LibraryManager
   - Custom shelves funcionando 100%

### Status Atual:
- Backend: 100% funcional
- Frontend: 100% funcional
- AJAX: 5 endpoints funcionando perfeitamente
- Biblioteca: Interface completa com remoção visual
- Prateleiras Personalizadas: Totalmente integradas
- Bugs conhecidos: Nenhum

### Próxima Sessão:
- **Sistema de Carrinho:** Models + Views + Templates
- **Filtros Avançados:** Catálogo com filtros e ordenação
- **Mover Livros:** Botão "Mover para..." nas prateleiras

---

**Última atualização:** 05/10/2025 - 20:30  
**Desenvolvedor:** Claude + cgvargas  
**Status:** Sistema de Biblioteca Pessoal 100% funcional