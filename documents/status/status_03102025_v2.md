# 📄 CGBookStore v3 - Documento de Estado do Projeto

**Data:** 03/10/2025 - 21:30  
**Versão:** 4.0  
**Última Atualização:** Integração Google Books API e Interface Admin completa

---

## 🎯 Visão Geral do Projeto

**CGBookStore v3** é uma livraria online desenvolvida em Django 5.0.3 com PostgreSQL (Supabase), focada em proporcionar uma experiência completa de leitura com biblioteca pessoal gamificada, sistema de eventos literários e integração com Google Books API.

### Tecnologias Principais
- **Backend:** Django 5.0.3
- **Banco de Dados:** PostgreSQL 17.6 (Supabase) ✅ **MIGRADO**
- **Python:** 3.13
- **Frontend:** Bootstrap 5, Font Awesome, Swiper.js
- **APIs:** Google Books API ✅ **INTEGRADO**
- **Controle de Versão:** Git + GitHub

---

## 📂 Estrutura Atual do Projeto

```
C:\ProjectDjango\cgbookstore_v3\
├── cgbookstore/              # Configurações do projeto
│   ├── settings.py           # ✅ Supabase + Google Books API configurado
│   ├── urls.py               # ✅ Static/Media configurado
│   └── wsgi.py
│
├── core/                     # App principal (livraria)
│   ├── models/               # ✅ MODULAR
│   │   ├── __init__.py
│   │   ├── category.py
│   │   ├── author.py         # ✅ COM FOTO + REDES SOCIAIS
│   │   ├── book.py
│   │   ├── video.py
│   │   ├── section.py
│   │   ├── section_item.py
│   │   └── event.py
│   │
│   ├── admin/                # ✅ ADMIN MODULAR
│   │   ├── __init__.py       # ✅ URLs customizadas Google Books
│   │   ├── category_admin.py
│   │   ├── author_admin.py
│   │   ├── book_admin.py
│   │   ├── video_admin.py
│   │   ├── section_admin.py  # ✅ Dropdown dinâmico
│   │   ├── event_admin.py
│   │   └── widgets.py
│   │
│   ├── management/           # ✅ Management Commands
│   │   ├── __init__.py
│   │   └── commands/
│   │       ├── __init__.py
│   │       ├── populate_db.py          # ✅ Popular banco
│   │       ├── add_book_covers.py      # ✅ Capas placeholder
│   │       ├── update_covers_google.py # ✅ NOVO - Capas Google Books
│   │       └── test_google_books.py    # ✅ NOVO - Testar API
│   │
│   ├── utils/                # ✅ NOVO - Utilitários
│   │   ├── __init__.py
│   │   └── google_books_api.py  # ✅ NOVO - Integração Google Books
│   │
│   ├── views/                # ✅ Modular
│   │   ├── __init__.py
│   │   ├── home_view.py
│   │   ├── book_views.py
│   │   ├── book_detail_view.py
│   │   ├── search_view.py
│   │   ├── about_view.py
│   │   ├── contact_view.py
│   │   ├── library_view.py
│   │   ├── event_views.py
│   │   └── google_books_views.py  # ✅ NOVO - Admin Google Books
│   │
│   ├── templatetags/         # ✅ Template tags customizados
│   │   ├── __init__.py
│   │   └── custom_filters.py # ✅ Sistema de 5 estrelas
│   │
│   ├── migrations/
│   │   ├── 0001_initial.py
│   │   ├── 0002_*.py
│   │   ├── 0003_*.py
│   │   ├── 0004_video_section_sectionitem.py
│   │   ├── 0005_author_photo_*.py
│   │   └── 0006_event.py
│   │
│   └── urls.py
│
├── accounts/                 # App de autenticação
│   ├── forms.py
│   ├── views.py
│   ├── urls.py
│   └── admin.py
│
├── chatbot_literario/        # App do chatbot (placeholder)
│   ├── views.py
│   └── urls.py
│
├── templates/
│   ├── base.html             # ✅ Theme switcher integrado
│   ├── core/
│   │   ├── home.html         # ✅ Seções dinâmicas
│   │   ├── book_list.html
│   │   ├── book_detail.html  # ✅ Adaptado aos temas
│   │   ├── search_results.html
│   │   ├── about.html
│   │   ├── contact.html
│   │   ├── library.html
│   │   ├── events.html
│   │   └── widgets/
│   │       └── event_widget.html
│   ├── accounts/
│   │   ├── login.html
│   │   └── register.html
│   └── admin/                # ✅ NOVO - Templates Admin
│       └── core/
│           └── book/
│               └── google_books_search.html  # ✅ NOVO - Busca Google Books
│
├── static/
│   ├── css/
│   │   ├── carousel.css      # ✅ Adaptado com variáveis CSS
│   │   └── themes.css        # ✅ Sistema de temas completo
│   └── js/
│       └── theme-switcher.js # ✅ Lógica de alternância
│
├── media/                    # ✅ Configurado e funcionando
│   ├── books/covers/         # ✅ 39 capas do Google Books + 8 placeholder
│   ├── authors/photos/
│   └── events/
│       ├── banners/
│       └── thumbnails/
│
├── documents/
│   └── status/
│       ├── status_29092025.md
│       ├── status_30092025.md
│       ├── status_02102025.md
│       ├── status_02102025_v2.md
│       ├── status_03102025_v3.md
│       └── status_03102025_v4.md  # Este arquivo
│
├── .venv/                    # Ambiente virtual
├── .gitignore
├── requirements.txt          # ✅ Atualizado com requests
├── manage.py
└── .env                      # ✅ Credenciais Supabase + Google Books API
```

---

## ✅ Funcionalidades Implementadas

### Core (Livraria)
- ✅ Página inicial com seções dinâmicas gerenciáveis pelo admin
- ✅ **5 seções criadas:** Lançamentos 2025, Fantasia, Clássicos, Mais Vendidos, Autores
- ✅ Widget de evento na home
- ✅ Página de eventos (`/eventos/`)
- ✅ Catálogo de livros com paginação (12 por página)
- ✅ BookDetailView completa
- ✅ Sistema de avaliação com 5 estrelas
- ✅ Sistema de busca (título, autor, categoria)
- ✅ Página "Sobre" institucional
- ✅ Formulário de contato
- ✅ Página de biblioteca pessoal (placeholder)
- ✅ Upload de imagens funcionando
- ✅ Navegação com breadcrumbs
- ✅ Livros relacionados por categoria

### Sistema de Temas ✨ (Implementado 03/10/2025)
- ✅ **3 Temas:** Claro, Escuro, Sistema (auto)
- ✅ **Variáveis CSS organizadas** para todas as cores
- ✅ **Persistência no localStorage** - tema salvo entre sessões
- ✅ **Detecção automática** de preferência do sistema operacional
- ✅ **Transições suaves** entre temas
- ✅ **Switcher visual** no navbar com dropdown
- ✅ **Contraste otimizado** em todos os componentes
- ✅ **Ícones adaptáveis** ao tema
- ✅ **Cards, botões, forms** totalmente adaptados
- ✅ **Breadcrumbs, dropdowns, modais** adaptados

### Sistema de Seções Dinâmicas
- ✅ Model Section - criar seções personalizadas
- ✅ Model SectionItem - associar conteúdo
- ✅ 3 tipos de layout: carrossel, grid, lista
- ✅ 3 tipos de conteúdo: livros, autores, vídeos
- ✅ Admin com preview visual dos itens
- ✅ Ordenação de seções e itens
- ✅ Ativar/Desativar seções

### Sistema de Avaliação com Estrelas
- ✅ Template tag customizado (`custom_filters.py`)
- ✅ Renderização de 5 estrelas baseada no rating
- ✅ Preenchimento parcial (cheia, meia, vazia)
- ✅ Tamanho reduzido das estrelas
- ✅ Valor numérico ao lado
- ✅ Fallback para livros sem avaliação
- ✅ Funciona em todos os layouts

### Sistema de Vídeos
- ✅ Model Video - YouTube, Vimeo, Instagram, TikTok
- ✅ Tipos: trailer, entrevista, resenha, tutorial
- ✅ Relacionamentos: livros e autores
- ✅ Extração automática de embed code e thumbnail
- ✅ Admin completo com autocomplete

### Sistema de Eventos Literários
- ✅ Model Event completo
- ✅ Status automático (próximo, acontecendo, finalizado)
- ✅ Widget na home
- ✅ Página `/eventos/`
- ✅ Admin avançado com badges e ações

### Autenticação
- ✅ Registro de usuários
- ✅ Login/Logout
- ✅ Proteção de rotas
- ✅ Navbar dinâmica
- ✅ Link Admin no dropdown para staff/superuser

### Admin Melhorado
- ✅ Preview visual em SectionItemInline
- ✅ Validação robusta de object_id e slugs
- ✅ Mensagens de erro claras
- ✅ Contador inteligente de itens (com cores)
- ✅ Interface organizada com fieldsets
- ✅ Autocomplete em BookAdmin e AuthorAdmin
- ✅ **URLs customizadas para Google Books** ✨ NOVO

### Management Commands ✨ (03/10/2025)

#### `populate_db.py`
- ✅ Popular banco de dados automaticamente
- ✅ **15 categorias** diversificadas criadas
- ✅ **22 autores** (brasileiros e internacionais) criados
- ✅ **47 livros** com ratings (3.5 a 5.0) e preços (R$ 25 a R$ 90) criados
- ✅ Validação de duplicatas
- ✅ Detecção de erros de relacionamento
- ✅ Argumentos: `--clear`, `--books=N`, `--verbose`

**Uso:**
```bash
python manage.py populate_db
python manage.py populate_db --clear --verbose
python manage.py populate_db --books=30
```

#### `add_book_covers.py`
- ✅ Adicionar capas placeholder aos livros
- ✅ **47 capas** baixadas do Lorem Picsum (400x600)
- ✅ Seeds únicos baseados no ID do livro
- ✅ Tratamento robusto de erros (timeout, rede)
- ✅ Argumentos: `--force`, `--verbose`

**Uso:**
```bash
python manage.py add_book_covers
python manage.py add_book_covers --force --verbose
```

#### `update_covers_google.py` ✨ NOVO
- ✅ Atualizar capas usando Google Books API
- ✅ **39/47 capas reais** baixadas (83% sucesso)
- ✅ Substituir capas existentes ou apenas adicionar novas
- ✅ Argumentos: `--force`, `--book-id=N`, `--limit=N`, `--delay=N`
- ✅ Estatísticas detalhadas no final
- ✅ Delay configurável entre requisições

**Uso:**
```bash
python manage.py update_covers_google --force --delay 0.5
python manage.py update_covers_google --book-id 2 --force
python manage.py update_covers_google --limit 10
```

#### `test_google_books.py` ✨ NOVO
- ✅ Testar integração com Google Books API
- ✅ Buscar por título, autor, ISBN, editora, query geral
- ✅ Exibição formatada dos resultados
- ✅ Argumentos: `--title`, `--author`, `--isbn`, `--publisher`, `--query`, `--max-results`

**Uso:**
```bash
python manage.py test_google_books --title "Harry Potter" --max-results 3
python manage.py test_google_books --author "J.K. Rowling"
python manage.py test_google_books --isbn "9781781103685"
```

### Sistema de Dropdown Dinâmico (03/10/2025)

#### SectionItemAdminForm
- ✅ **Form customizado** para SectionItem
- ✅ **3 dropdowns separados** (Book, Author, Video)
- ✅ Exibição inteligente: "Título - Autor" para livros
- ✅ Ordenação alfabética
- ✅ Empty label descritivo
- ✅ Método `clean()` para validação
- ✅ Método `save()` customizado para setar `object_id`
- ✅ Preview visual após salvar
- ✅ Validação robusta com mensagens claras
- ✅ Funciona tanto em inline quanto em admin standalone

### Google Books API Integration ✨ NOVO (03/10/2025)

#### `core/utils/google_books_api.py`
**Funções principais:**
- ✅ `search_books()` - Busca por título, autor, ISBN, editora
- ✅ `get_book_by_id()` - Buscar detalhes por ID do Google Books
- ✅ `get_book_by_isbn()` - Buscar por ISBN específico
- ✅ `search_books_by_author()` - Todos os livros de um autor
- ✅ `search_books_by_publisher()` - Todos os livros de uma editora
- ✅ `extract_book_info()` - Processar resposta da API
- ✅ `download_cover()` - Baixar e salvar capa
- ✅ `update_book_cover_from_google()` - Atualizar capa de um livro

**Recursos:**
- ✅ Suporte a API key do Google (opcional, melhora rate limit)
- ✅ Priorização de resultados em português
- ✅ Timeout de 10s para segurança
- ✅ Logging detalhado de erros
- ✅ Extração de ISBN-13 e ISBN-10
- ✅ Download automático de capas em HTTPS
- ✅ Sobrescrita inteligente de arquivos

#### Interface Admin Google Books ✨ NOVO
**URL:** `/admin/google-books/search/`

**Recursos:**
- ✅ Formulário de busca avançada
- ✅ Campos: Busca Geral, Título, Autor, ISBN, Editora
- ✅ Design moderno com card preta e inputs escuros
- ✅ Grid responsivo de resultados
- ✅ Preview de capas dos livros
- ✅ Informações completas: autor, editora, ISBN, páginas, avaliação
- ✅ Botão "Importar para Catálogo" em cada livro
- ✅ **Paginação:** Até 200 livros (20 páginas × 10 livros) 🔄 EM DESENVOLVIMENTO
- ✅ Contador de resultados encontrados
- ✅ Botão "Limpar" para resetar busca

**Importação automática:**
- ✅ Cria/vincula autor automaticamente
- ✅ Cria/vincula categoria automaticamente
- ✅ Baixa capa automaticamente
- ✅ Preenche todos os campos (título, subtítulo, ISBN, descrição, etc.)
- ✅ Verifica duplicatas por ISBN
- ✅ Feedback visual de sucesso/erro
- ✅ Link direto para editar livro importado

---

## 🗺️ URLs Mapeadas

| URL | View | Nome | Autenticação |
|-----|------|------|--------------|
| `/` | HomeView | `core:home` | Não |
| `/livros/` | BookListView | `core:book_list` | Não |
| `/livros/<slug>/` | BookDetailView | `core:book_detail` | Não |
| `/buscar/` | SearchView | `core:search` | Não |
| `/sobre/` | AboutView | `core:about` | Não |
| `/contato/` | ContactView | `core:contact` | Não |
| `/biblioteca/` | LibraryView | `core:library` | **Sim** |
| `/eventos/` | EventListView | `core:events` | Não |
| `/contas/login/` | LoginView | `accounts:login` | Não |
| `/contas/registrar/` | RegisterView | `accounts:register` | Não |
| `/contas/logout/` | LogoutView | `accounts:logout` | Sim |
| `/chatbot/` | ChatbotView | `chatbot:chat` | Não |
| `/admin/` | Admin | `admin:index` | Sim (staff) |
| `/admin/google-books/search/` | google_books_search | `admin:google_books_search` | Sim (staff) ✨ **NOVO** |
| `/admin/google-books/import/<id>/` | google_books_import | `admin:google_books_import` | Sim (staff) ✨ **NOVO** |

---

## 🔧 Configurações Importantes

### Banco de Dados (settings.py)
```python
import dj_database_url
from decouple import config

DATABASES = {
    'default': dj_database_url.config(
        default=config('DATABASE_URL'),
        conn_max_age=60,
        conn_health_checks=True,
    )
}
```

### Arquivos Estáticos e Media
```python
STATIC_URL = '/static/'
STATICFILES_DIRS = [os.path.join(BASE_DIR, 'static')]
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')

MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')
```

### Google Books API
```python
GOOGLE_BOOKS_API_KEY = config('GOOGLE_BOOKS_API_KEY', default='')
```

### Variáveis de Ambiente (.env)
```env
SECRET_KEY=Oa023568910@
DEBUG=True
ALLOWED_HOSTS=localhost,127.0.0.1

# Supabase PostgreSQL
DATABASE_URL=postgresql://postgres.uomjbcuowfgcwhsejatn:Oa023568910@@aws-1-sa-east-1.pooler.supabase.com:5432/postgres

# Supabase API
SUPABASE_URL=https://uomjbcuowfgcwhsejatn.supabase.co
SUPABASE_ANON_KEY=eyJhbG...
SUPABASE_SERVICE_KEY=eyJhbG...

# Google Books API
GOOGLE_BOOKS_API_KEY=AIzaSyBF5W5NktgXZRfTnZXe3pVxqB_TCkXGzx0
```

---

## 📦 Dependências (requirements.txt)

```txt
Django==5.0.3
django-environ==0.11.2
python-decouple==3.8
psycopg[binary]>=3.1.0
dj-database-url==2.1.0
supabase>=2.4.0
storage3>=0.7.3
gotrue>=2.4.1
postgrest>=0.16.0
realtime>=2.0.0
supafunc>=0.4.0
Pillow>=10.0.0
requests>=2.31.0
```

---

## 🛠️ Problemas Resolvidos na Sessão (03/10/2025)

### 1. Seções na Home ✅
**Implementação:** 5 seções dinâmicas criadas via Admin  
**Status:** Resolvido - home exibindo todas as seções perfeitamente

### 2. Integração Google Books API ✅
**Implementação:** Módulo completo de integração  
**Status:** Resolvido - buscas funcionando, 39/47 capas reais baixadas

### 3. Campo cover vs cover_image ✅
**Problema:** Nomenclatura incorreta no código  
**Solução:** Corrigido em todos os arquivos para `cover_image`  
**Status:** Resolvido

### 4. Capas não sendo substituídas ✅
**Problema:** Função criava arquivos novos ao invés de sobrescrever  
**Solução:** Ajustada função `download_cover()` para deletar e substituir  
**Status:** Resolvido - capas sendo atualizadas corretamente

### 5. Interface Admin Google Books ✅
**Implementação:** Template customizado com busca e importação  
**Status:** Resolvido - interface funcionando, design moderno aplicado

### 6. Paginação Google Books 🔄
**Implementação:** Sistema de paginação (20 páginas × 10 livros)  
**Status:** EM DESENVOLVIMENTO - lógica implementada, aguardando teste

---

## 🚧 Próximas Funcionalidades Planejadas

### Prioridade ALTA

**1. Finalizar Paginação Google Books** 🔄 EM ANDAMENTO
   - Testar navegação entre páginas
   - Validar query params nas páginas
   - Ajustar estilos se necessário

**2. Botão "Buscar no Google Books" no BookAdmin**
   - Link direto do admin de livros para interface de busca
   - Pre-preencher campos com dados do livro atual
   - Facilitar atualização de dados

**3. Dashboard Admin Personalizada**
   - Estatísticas gerais (livros, autores, eventos, capas com Google Books)
   - Gráficos (Chart.js)
   - Ações rápidas
   - Atalhos para seções mais usadas
   - Widget de status da API do Google Books

**4. Sistema de Sincronização Automática**
   - Command para atualizar metadados de livros existentes
   - Verificar livros novos no Google Books
   - Atualizar ratings e reviews
   - Schedule com Celery (futuro)

### Prioridade MÉDIA

**5. Sistema de Biblioteca Pessoal (Backend)**
   - Models: UserProfile, BookShelf, ReadingProgress, BookReview
   - CRUD de prateleiras personalizadas
   - Progresso de leitura (%)
   - Sistema de avaliações privadas

**6. Sistema de Carrinho de Compras**
   - Models: Cart, CartItem, Order
   - Checkout básico
   - Integração com pagamento (futuro)

**7. Filtros Avançados no Catálogo**
   - Filtro por categoria
   - Filtro por faixa de preço
   - Ordenação (preço, data, título, avaliação)
   - Busca avançada

**8. Sistema de Reviews Público**
   - Comentários públicos nos livros
   - Sistema de likes/dislikes
   - Moderação

### Prioridade BAIXA

**9. Chatbot Literário Funcional**
   - Integração com API (OpenAI/Ollama)
   - Recomendações personalizadas
   - Conversação sobre livros

**10. Gamificação**
    - Sistema de pontos por leitura
    - Conquistas (badges)
    - Ranking de leitores
    - Desafios de leitura

**11. Sistema de Usuários Avançado**
    - Models: UserActivity, Subscription, Partnership
    - Planos (Free, Premium)
    - Rastreamento de comportamento
    - Analytics

---

## 🎯 Conquistas da Sessão (03/10/2025)

### ✅ Seções Dinâmicas na Home
- 5 seções criadas e funcionando
- Lançamentos 2025 (Grid - 8 livros)
- Fantasia (Carrossel - 6 livros)
- Clássicos da Literatura (Grid - 8 livros)
- Mais Vendidos (Grid - 7 livros)
- Autores (Lista - 5 autores)

### ✅ Google Books API - Integração Completa
- Módulo `google_books_api.py` com 10 funções
- Busca por título, autor, ISBN, editora
- Download automático de capas
- 39/47 capas reais baixadas (83% sucesso)
- API key configurada
- Logging completo

### ✅ Management Commands para Google Books
- `test_google_books.py` - testar buscas
- `update_covers_google.py` - atualizar capas em massa
- Argumentos flexíveis (--force, --limit, --delay, --book-id)
- Estatísticas detalhadas
- Tratamento robusto de erros

### ✅ Interface Admin Google Books
- URL customizada no admin
- Template moderno com design escuro
- Formulário de busca avançada
- Grid de resultados com capas
- Importação automática com um clique
- Criação automática de autores e categorias
- Verificação de duplicatas por ISBN
- Feedback visual de sucesso/erro

### ✅ Sistema de Paginação (em desenvolvimento)
- Lógica implementada na view
- Suporte a 20 páginas × 10 livros = 200 livros
- Estilos CSS preparados
- Template com navegação
- Aguardando testes finais

---

## 📋 Comandos Úteis

### Ambiente Virtual
```powershell
# Ativar
.\.venv\Scripts\activate

# Desativar
deactivate
```

### Django
```powershell
# Rodar servidor
python manage.py runserver

# Criar migrations
python manage.py makemigrations

# Aplicar migrations
python manage.py migrate

# Criar superuser
python manage.py createsuperuser

# Shell interativo
python manage.py shell

# Verificar problemas
python manage.py check

# Popular banco de dados
python manage.py populate_db --verbose

# Adicionar capas placeholder
python manage.py add_book_covers --verbose

# Atualizar capas com Google Books
python manage.py update_covers_google --force --delay 0.5

# Testar Google Books API
python manage.py test_google_books --title "Harry Potter" --max-results 3
```

### Git
```powershell
git status
git add .
git commit -m "Feat: Descrição"
git push
```

---

## 🗂️ Últimos Commits Importantes

```bash
✅ Feat: Implementa integração completa com Google Books API
✅ Feat: Adiciona google_books_api.py com 10 funções
✅ Feat: Cria update_covers_google.py e test_google_books.py
✅ Feat: Interface Admin para buscar e importar livros do Google Books
✅ Feat: Template google_books_search.html com design moderno
✅ Feat: Sistema de paginação (20 páginas × 10 livros)
✅ Fix: Corrige campo cover para cover_image em todos os arquivos
✅ Fix: Ajusta download_cover() para sobrescrever arquivos existentes
✅ Feat: 39/47 capas reais baixadas do Google Books
✅ Feat: URLs customizadas no Admin para Google Books
✅ Style: Design escuro no formulário de busca
```

---

## 🌐 Links Importantes

### Repositório
- **GitHub:** https://github.com/cgvargas/cgbookstore_v3
- **Branch Principal:** main

### Documentação
- **Django Docs:** https://docs.djangoproject.com/en/5.0/
- **Bootstrap 5:** https://getbootstrap.com/docs/5.3/
- **Supabase Docs:** https://supabase.com/docs
- **Swiper.js:** https://swiperjs.com/
- **Font Awesome:** https://fontawesome.com/icons
- **Google Books API:** https://developers.google.com/books
- **Lorem Picsum:** https://picsum.photos/

### Supabase
- **Dashboard:** https://supabase.com/dashboard
- **Project:** uomjbcuowfgcwhsejatn

---

## 📋 Credenciais de Acesso

### Admin Django
- **URL:** http://127.0.0.1:8000/admin/
- **User:** admin
- **Password:** Oa023568910@

### Google Books Search
- **URL:** http://127.0.0.1:8000/admin/google-books/search/
- **Requer:** Login como staff/superuser

### Supabase
- **URL:** https://uomjbcuowf